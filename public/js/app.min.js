var currentDepartmentId,st_ver="0.167",tg=window.Telegram.WebApp,ball=document.getElementById("load-wrap"),notifier=document.getElementById("notifier");tg.expand(),tg.SettingsButton.show(),tg.BackButton.hide(),tg.enableClosingConfirmation(),Telegram.WebApp.onEvent("settingsButtonClicked",function(){window.location.reload(!0)});let theme=tg.themeParams,platform=tg.platform;(btnOpen=document.getElementById("open_scanner")).style.backgroundColor=theme.button_color,btnOpen.style.color=theme.button_text_color;var tableId=null;function updateTableNumber(){if(null!==tableId&&/^\d+$/.test(tableId)){$("#tablenumber").val(tableId),$("#tablenumber").text(" \uD83C\uDF7D Номер стола: "+tableId),tg.closeScanQrPopup(),notify("Номер стола: ",tableId);return}return console.error("Некорректный tableId:",tableId),tg.showAlert("Не смог распознать qr-code"),!1}tg.onEvent("qrTextReceived",async function({data:e}){var t,n=e.toString().toLowerCase();if(n.startsWith("http://")||n.startsWith("https://")){if(n.startsWith("https://tapper.cloud/")){let o,a,r,i=(o=(t=n).indexOf("https://tapper.cloud/")+21,(r=(a=t.substring(o).split("/"))[a.length-1].match(/\d+/))?r[0]:null);return console.log("Последняя цифра:",i),tableId=i,updateTableNumber()}if(n.startsWith("https://eda.yandex.ru/inplace/menu?uuid=")){let l=function e(t,n){let o=t.indexOf(n+"=");if(-1===o)return null;o+=n.length+1;let a=t.indexOf("&",o);return -1===a&&(a=t.length),t.substring(o,a)}(n,"uuid");console.log("Значение uuid:",l);let s={uuid:l};async function d(){try{let e=await fetch("https://api.edatg.ru/webhook/tableId",{method:"POST",headers:{"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify(s)});if(!e.ok)throw Error("Network response was not ok");let t=await e.json();return console.log("Ответ сервера:",t),tableId=t.table_id,console.log("Полученный tableId:",tableId),updateTableNumber()}catch(n){console.error("Ошибка при выполнении запроса:",n)}}d()}}else tg.showAlert("Не смог распознать qr-code")}),btnOpen.addEventListener("click",function(){try{if("tdesktop"===platform){notify("Сканирование недоступно");return}tg.showScanQrPopup({text:tableId?`Номер стола: ${tableId}`:"Отсканируйте qr-code стола"},function(){return!1})}catch(e){console.error("Произошла ошибка: ",e.message)}});var departments={},$message=$("#message"),streetInput=$("#street"),selection="<option value='now'>⌚️ Ближайшее время</option>";function preload(e){e.style.opacity=1;var t=setInterval(function(){e.style.opacity=e.style.opacity-.05,e.style.opacity<=.05&&(clearInterval(t),ball.style.display="none")},15)}function notify(e){notifier.className,notifier.className="warning show",$("#notifier").text(e),setTimeout(function(){notifier.className="warning"},1500)}function getMachineId(){try{let e=localStorage.getItem("uuid");return e||(e=self.UUID.generate(),localStorage.setItem("uuid",e)),e}catch(t){return console.log(t),"error"}}function zeroFill(e,t){return(t-=e.toString().length)>0?Array(t+(/\./.test(e)?2:1)).join("0")+e:e+""}function getPersonalData(){let e=localStorage.getItem("personalData");return e?JSON.parse(e):{name:null,phone:null}}function getStoredData(){let e=localStorage.getItem("addressData");return e?JSON.parse(e):{historySelectedAddresses:[]}}function saveStoredData(e){localStorage.setItem("addressData",JSON.stringify(e))}function get_data_load(){let{name:e,phone:t}=getPersonalData(),{lastSelectedAddress:n,historySelectedAddresses:o}=getStoredData();e&&$("#name").val(e),t&&$("#phone").val(t),n&&($('label[for="street"]').text(n.country+", "+n.city),streetInput.val(n.short||n.full),streetInput.val()&&streetInput.parent().addClass("has-value"),Object.entries({flat:"#flat",floor:"#floor",entrance:"#entrance",intercom:"#intercom",comment:"#order_place_comment"}).forEach(([e,t])=>{n.rawDetails[e]&&(console.log(`Найден: ${e}`),$(t).val(n.rawDetails[e]))}))}async function authorizeUser(){try{if(!obj.public||!obj.bot)throw Error("Недостаточно данных для выполнения запроса.");let e={method:"POST",headers:{"Content-Type":"application/json","X-Custom-Token":obj.public,"X-User-Info":getMachineId()},body:JSON.stringify({task:"auth"})},t=new AbortController,n=t.signal,o="https://api.edatg.ru/webhook/v1/auth/?bot_id="+obj.bot,a=setTimeout(()=>{t.abort()},1e4),r=await fetch(o,{...e,signal:n});if(clearTimeout(a),console.log(`HTTP Status Code: ${r.status}`),r.ok){let i=await r.json(),l=i.access_token,s=i.refresh_token;l&&s?(saveTokens(l,s,i.access_token_expires_at,i.refresh_token_expires_at),console.log("User authorized successfully!")):console.error("Failed to retrieve tokens from the server response."),console.log("Authorization successful.")}else{let d=await r.text();throw console.error("Authorization failed:",r.statusText),Error(`Ошибка запроса: ${r.status} - ${d}`)}}catch(c){if(console.error("Ошибка запроса:",c),c.message.includes("401")){let u="Сессия истекла. Пожалуйста, авторизуйтесь заново.";console.error("Ошибка 401:",u),notify(u),$("#error_load").text(u)}else if("AbortError"===c.name)notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.");else{let p="Упс, что-то пошло не так. Скоро всё починим.\n Попробуйте отключить VPN и повторить попытку.";notify(p),$("#error_load").text(p)}throw c}}async function refreshAccessToken(){try{let e=getTokens();if(!e.refreshToken){console.log("No access token found, authorizing user..."),await authorizeUser();return}let t=await fetch(`https://api.edatg.ru/webhook/v1/task/?bot_id=${obj.bot}`,{method:"POST",headers:{Authorization:"Bearer "+e.refreshToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"refresh_token"})});if(t.ok){let n=await t.json(),o=n.access_token;if(o)return saveTokens(n.access_token,n.refresh_token,n.access_token_expires_at,n.refresh_token_expires_at),console.log("Token refreshed successfully!"),o;return console.error("Failed to retrieve new access token from the server response."),null}console.error("Failed to refresh access token:",t.statusText),await authorizeUser()}catch(a){console.error("Error during token refresh:",a),await authorizeUser()}}async function getDepartments(){if(!obj.bot){console.error("No access token found. Please authorize first.");return}let e=getTokens(),t={method:"POST",headers:{Authorization:"Bearer "+e.accessToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"departments"})},n="https://api.edatg.ru/webhook/v1/task/?bot_id="+obj.bot;try{let o=await fetch(n,t);if(401===o.status){if(console.log("Token expired, trying to refresh..."),token=await refreshAccessToken())t.headers.Authorization="Bearer "+token,o=await fetch(n,t);else{console.error("Unable to refresh token. Please log in again.");return}}if(o.ok){let a=await o.json();return a}console.error("Failed to fetch departments:",o.statusText)}catch(r){throw"AbortError"===r.name&&(notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.")),console.error("Error during the departments request:",r),r}}function checkAndUpdateTimeSelection(e){console.log("checkAndUpdateTimeSelection:",e);var t=$("select").val();if("now"===t)return!1;var n=moment(t),o=moment().tz(e.time_zona),a="delivery"===$("input[name=shipping_type]:checked").val()?e.eta:0,r=e.cooking_time;return console.log("Current time:",o.format("HH:mm")),console.log("Selected time:",n.format("HH:mm")),n.diff(o,"minutes")<=a+r&&(console.log("Difference in minutes:",n.diff(o,"minutes")),updateAvailableTimes(e.id),tg.showAlert("Выбранное время больше не доступно, пожалуйста, выберите новое время."),!0)}function updateAvailableTimes(e){currentDepartmentId=e,console.log("Updating times for department ID:",e);var t=departments.globalSettings.departments.find(function(t){return t.id===e});if(t){var n,o=t.workTime,a=moment().tz(t.time_zona),r=$("input[name=shipping_type]:checked").val(),i=("delivery"===r?t.eta:0)+t.cooking_time,l="delivery"===r?30:15,s=a.clone().add(i,"minutes"),d=Math.ceil(s.minutes()/l)*l;s.minutes(d).seconds(0),console.log("Adjusted time after rounding to nearest interval:",s.format("YYYY-MM-DD HH:mm")),$("select").empty();var c,u,p,m,g=(c=[s,moment().add(1,"days").tz(t.time_zona)],u=o,p="",m=!1,c.forEach(function(e,t){var n=e.isSame(a,"day"),o=n?"Сегодня":"Завтра",r=u[t].fullDay?moment(e).startOf("day"):moment(u[t].from,"HH:mm").set({year:e.year(),month:e.month(),date:e.date()}),d=u[t].fullDay?moment(e).endOf("day"):moment(u[t].to,"HH:mm").set({year:e.year(),month:e.month(),date:e.date()});if(s.isBefore(r)){var c=Math.ceil((s=r.clone().add(i,"minutes")).minutes()/l)*l;s.minutes(c).seconds(0)}console.log(`Work hours open for ${o} (with totalTime):`,s.format("HH:mm")),console.log(`Work hours close for ${o}:`,d.format("HH:mm"));var g=d.clone();if(n&&!m){let f=g.diff(a,"minutes"),y=a.diff(r,"minutes");u[t].fullDay||y>0&&f>i?(console.log(`Adding nearest time option for ${o}`),p+=`<option value='now'>⌚️ Ближайшее время</option>`,m=!0):(f<=i&&tg.showAlert(`До закрытия заведения осталось меньше времени, чем требуется для доставки. Заказ возможен только на завтра с ${r.format("HH:mm")}.`),y<0&&tg.showAlert(`Мы начнём принимать заказы с ${r.format("HH:mm YYYY-MM-DD")}.`))}for(var h=s.clone();h.isBefore(g)||h.isSame(g);){var b=h.format("HH:mm"),v=h.format();if(console.log(`Adding option for ${o}: ${b}`),p+=`<option value='${v}'>⌚️ ${b} ${o}</option>`,h.add(l,"minutes"),h.isAfter(g))break}p+=`<option value='${g.format()}'>⌚️ ${g.format("HH:mm")} ${o}</option>`}),p);$("select").html(g),checkAndUpdateTimeSelection(t)}}function confirmationSendData(){console.log("Вызывает кнопку продолжить: проверка данных на заполнение полей"),notify("Загрузка формы...");try{tg.MainButton.showProgress();var e=$("#name")[0],t=e.value,n=$("#phone")[0],o=n.value;if(t.length<2)return e.focus(),e.reportValidity(),notify("Имя указано некорректно");if(o.length<18)return n.focus(),n.reportValidity(),notify("Телефон указан некорректно");localStorage.setItem("personalData",JSON.stringify({name:t,phone:o}));var a=departments.globalSettings.departments.find(function(e){return e.id===currentDepartmentId});if(checkAndUpdateTimeSelection(a))return;var r=$("input[name=shipping_type]:checked").val(),i=$("input[name=payment_type]:checked").val(),l=$("input[name=address_pickup]:checked").val(),s={platform:platform,guuid:getMachineId(),web_ver:st_ver,name:t,phone:o,shipping_type:null,payment_type:null,delivery_time:$("#delivery_time").val(),cutlery:$("#cutlery").val(),comment:$("#comment").val(),promocode:{code:$("#promoCodeInput").val()},tablenumber:"",address:null};if("delivery"==r){s.shipping_type="delivery",console.log("\uD83D\uDE9B Доставка");let d=getStoredData(),{lastSelectedAddress:c,historySelectedAddresses:u}=d;if(null==c){document.getElementById("street").click(),notify("Выберите Улицу");return}c.rawDetails.flat=$("#flat").val(),c.rawDetails.floor=$("#floor").val(),c.rawDetails.entrance=$("#entrance").val(),c.rawDetails.intercom=$("#intercom").val(),c.rawDetails.comment=$("#order_place_comment").val(),d.lastSelectedAddress=c;let p=u.findIndex(e=>e.id===c.id);-1!==p?u[p]={...u[p],...c}:u.push(c),saveStoredData(d),s.address={full_street:c.full,short:c.short,country:c.country,city:c.city,street:c.street,house:c.house,building:c.building,areas:c.areas,coordinates:c?.coordinates??null,flat:c.rawDetails.flat,floor:c.rawDetails.floor,entrance:c.rawDetails.entrance,intercom:c.rawDetails.intercom,order_place_comment:c.rawDetails.comment,location:{lat:c.lat,lon:c.lon}},null==!s.address.full_street&&(document.getElementById("street").click(),notify("Что-то пошло не так, выберите снова улицу."))}else if("takeout"==r){if(null==l)return notify("Выберите где хотите забрать заказ");s.address_pickup=l,s.shipping_type="takeout"}else{if("inside"!=r)return console.warn("Неизвестный тип доставки: ",r),notify("Неизвестный тип доставки: ",r);if(null==l)return notify("Выберите где хотите забрать заказ");s.address_pickup=l,s.shipping_type="inside",s.tablenumber=$("#tablenumber").val(),console.log("\uD83C\uDF7D В заведении")}s.payment_type=i,tg.sendData(JSON.stringify(s))}catch(m){console.log("Ошибка",m),$("#error_t").text("Ошибка: "+m),notify("Ошибка: "+m)}finally{tg.MainButton.hideProgress()}}function button_sendData(){tg.MainButton.setParams({text:"Продолжить",color:"#32746a",text_color:"#FFFFFF",is_active:!0,is_visible:!0})}list_payment={paysbp:{alt:"СБП (Система быстрых платежей)",title:"СБП",img:"image/sbp_icons.png"},paycard:{alt:"Банковская карта",title:"Банковской картой онлайн",img:"image/card_icon.png"},paycash:{alt:"Наличными или картой при получении",title:"Наличными или картой при получении",img:"image/money_icon.png"}},validParams=["bot","public"];const params=window.location.search.substring(1).split("&"),filteredParams=params.filter(e=>([name]=e.split("="),validParams.includes(name))),obj={};for(const key of filteredParams){let[e,t]=key.split("=");obj[e]=t}try{if(obj.bot&&obj.public){localStorage.setItem(obj.bot,obj.public);let n=new URL(window.location);n.searchParams.delete("public"),window.history.replaceState({},document.title,n.toString())}else if(obj.bot){let o=localStorage.getItem(obj.bot);if(o)obj.public=o;else throw console.error("Параметр public не найден."),Error("Ошибка параметра запроса: public")}else throw console.error("Параметр bot не найден."),Error("Ошибка параметра запроса: bot")}catch(a){console.error("Ошибка запроса:",a);let r="Упс, что-то пошло не так. Пожалуйста, откройте страницу \xabОформить заказ\xbb ещё раз.";throw notify(r),$("#error_load").text(r),a}function DeliveryOptions(e){let t=document.getElementById("delivery-options-container"),n=document.getElementById("delivery-address"),o=document.getElementById("personal-details"),a=document.getElementById("pickup-location"),r=document.getElementById("table-number");function i(){let e=Array.from(t.children);e.sort((e,t)=>{let n=e.classList.contains("unavailable"),o=t.classList.contains("unavailable");return n&&!o?1:!n&&o?-1:0}),e.forEach(e=>{t.appendChild(e)})}function l(){if(!t){console.error("Delivery options container not found in the document.");return}t.innerHTML="",Object.keys(e).forEach(l=>{let s=e[l],d=function e(t,n,o,a){let r=document.createElement("label");r.classList.add("delivery-option"),a||r.classList.add("unavailable"),r.id=`option-item-${t}`;let i=document.createElement("input");i.classList.add("option-input"),i.id=`option-${t}`,i.name="shipping_type",i.type="radio",i.value=t,a||(i.disabled=!0);let l=document.createElement("div");l.classList.add("option-content");let s=document.createElement("div");s.classList.add("delivery-text"),s.textContent=n;let d=document.createElement("div");return d.classList.add("delivery-time"),d.textContent=o,l.appendChild(s),l.appendChild(d),r.appendChild(i),r.appendChild(l),r}(l,s.title,s.description,s.available);t.appendChild(d);let c=d.querySelector(".option-input");c.addEventListener("change",function(){(function i(){n.style.display="none",o.style.display="none",a.style.display="none",r.style.display="none";let l=t.querySelectorAll(".option-input");l.forEach(e=>e.parentElement.classList.remove("selected"));let s=t.querySelector(".option-input:checked");if(s){let d=s.value,c=e[d];c.available&&(s.parentElement.classList.add("selected"),"delivery"===d?(o.style.display="block",n.style.display="block"):"takeout"===d?(o.style.display="block",a.style.display="block"):"inside"===d&&(o.style.display="block",a.style.display="block",r.style.display="block"))}})(),i()})}),i();let l=t.querySelector(".option-input:not([disabled])");l&&(l.checked=!0,l.dispatchEvent(new Event("change")))}l(),function e(){let t=$(".delivery-container");$(".delivery-option").hover(function(){let e=t.scrollLeft(),n=t.width(),o=$(this),a=o.position().left,r=o.outerWidth();(a<0||a+r>n)&&t.animate({scrollLeft:e+a},120)})}(),window.updateDeliveryOptions=function t(n){Object.keys(e).forEach(t=>{n.hasOwnProperty(t)&&(e[t]=n[t])}),l()}}function loadParams(e){try{var t=getMachineId();guuid_platform=" GUID: "+t,$("#guuid").text(guuid_platform);let n=e.globalSettings.payment_methods,o=n;o=null==o||void 0===o?["paysbp"]:0===o.length?["paysbp"]:o.split(",");let a=["method1","method2"];o.length>0&&(a=o[0]);let r="";o.forEach(function(e){let t=e===a?"checked":"";r+=`<div class='radio-item'>
                        <input class='radio-list' type='radio' name='payment_type' id='${e}' value='${e}' required ${t}>
                        <label for='${e}'>
                            <img src='${list_payment[e].img}' alt='${list_payment[e].alt}' class='checkout-payment__slider-image'>
                            ${list_payment[e].title}
                        </label>
                    </div>`}),$(".payment-list").html(r);let i=e.globalSettings.delivery_methods;DeliveryOptions(i);var l="";for(var s in e.globalSettings.departments)l+="<div class='radio-item'>",l+="<input class='radio-list' type='radio' name='address_pickup' id='"+e.globalSettings.departments[s].id+"' value='"+e.globalSettings.departments[s].id+"' required>",l+="<label for='"+e.globalSettings.departments[s].id+"'>",l+="<img src='image/map_icon.png' alt='"+e.globalSettings.departments[s].address+"' class='checkout-payment__slider-image'>",l+=e.globalSettings.departments[s].address,l+="</label>",l+="</div>";function d(e,t){return(t-=e.toString().length)>0?Array(t+(/\./.test(e)?2:1)).join("0")+e:e+""}$(".departments").html(l),console.log("Departments:",e.globalSettings.departments),console.log("Selected Department ID:",""),$('input[type="radio"][name="address_pickup"]').change(function(){var t=$(this).val(),n=e.globalSettings.departments.find(function(e){return e.id===parseInt(t)});n?(console.log("Selected Department:",n),updateAvailableTimes(n.id),notify("Изменилось время доставки.")):console.log("Department not found for ID:",t)}),$("select").change(function(){var t=e.globalSettings.departments.find(function(e){return e.id===currentDepartmentId});checkAndUpdateTimeSelection(t)}),$(document).ready(function(){!function t(){if(e.globalSettings.departments.length>0){var n=e.globalSettings.departments[0].id;updateAvailableTimes(n),$("input[name=shipping_type]").change(function(){updateAvailableTimes(n)})}}()})}catch(c){console.log(c),notify("Ошибка загрузка сайта"),$("#error_load").text("Ошибка: "+c);return}$("#ver").text(" ver: "+st_ver),get_data_load()}function getCookie(e){let t=e+"=",n=document.cookie.split(";");for(let o=0;o<n.length;o++){let a=n[o];for(;" "===a.charAt(0);)a=a.substring(1,a.length);if(0===a.indexOf(t))return a.substring(t.length,a.length)}return null}function setCookie(e,t,n){let o="";if(n){let a=new Date;a.setTime(a.getTime()+864e5*n),o="; expires="+a.toUTCString()}document.cookie=e+"="+(t||"")+o+"; path=/"}function saveTokens(e,t,n,o){setCookie("access_token",e,7),setCookie("refresh_token",t,30),setCookie("access_token_expires_at",n,7),setCookie("refresh_token_expires_at",o,30)}function eraseCookie(e){document.cookie=e+"=; Max-Age=-99999999;"}function getTokens(){return{accessToken:getCookie("access_token"),refreshToken:getCookie("refresh_token"),accessTokenExpiresAt:getCookie("access_token_expires_at"),refreshTokenExpiresAt:getCookie("refresh_token_expires_at")}}async function checkTokenStatus(e){let t={method:"POST",headers:{"Content-Type":"application/json","X-User-Info":getMachineId(),Authorization:"Bearer "+e},body:JSON.stringify({task:"profile"})};try{let n=await fetch(`https://api.edatg.ru/webhook/v1/task/?bot_id=${obj.bot}`,t),o=await n.json();n.ok?console.log("Token is valid. User:",o.user):(console.log("Token is invalid or expired, refreshing..."),await refreshAccessToken())}catch(a){throw"AbortError"===a.name&&(notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.")),console.error("Error checking token status:",a),a}}async function checkAuthorization(){let e=getTokens();return!e.accessToken||hasTokenExpired(e.refreshTokenExpiresAt)?await authorizeUser():hasTokenExpired(e.accessTokenExpiresAt)?(console.log("Access token is missing or expired, authorizing user..."),await refreshAccessToken()):void(console.log("Access token is valid, checking token status..."),await checkTokenStatus(e.accessToken))}function hasTokenExpired(e){if(!e)return!0;let t=new Date(e),n=new Date;return n>=t}function toggleBodyScroll(e){e?(document.documentElement.setAttribute("data-hide-scroll",""),document.body.setAttribute("data-hide-scroll","")):(document.documentElement.removeAttribute("data-hide-scroll"),document.body.removeAttribute("data-hide-scroll"))}window.onload=async function(){await checkAuthorization(),getDepartments().then(e=>{console.log("API response:",e),departments=e,loadParams(e),preload(ball),button_sendData()}).catch(e=>{console.error("API error:",e)})},document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("addressModal"),t=document.getElementById("mapModal"),n=document.getElementById("open-modal"),o=document.getElementById("close-address-modal"),a=document.getElementById("map"),r=document.getElementById("address-input"),i=document.getElementById("suggestions"),l=document.getElementById("confirmed-addresses"),s=document.getElementById("current-address"),d,c,u,p=null,m=null,g=document.createElement("span");function f(e){g.style.display=e.length>0?"inline":"none"}function y(){if(!i.querySelector(".loading-hint")){i.innerHTML="";for(let e=0;e<2;e++){let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-hint loading-hint";let o=document.createElement("div");o.className="suggestion-subhint loading-subhint",t.appendChild(n),t.appendChild(o),i.appendChild(t)}}}function h(){if(m)return console.log("Координаты уже получены: ",m);geolocation.get({provider:"browser",autoReverseGeocode:!0,timeout:5e3}).then(function(e){a.style.display="block",t.style.display="flex",m=e.geoObjects.position.map(e=>Number(e)),console.log("Получены новые координаты: ",m),e.geoObjects.options.set("preset","islands#blueCircleIcon"),e.geoObjects.get(0).properties.set({balloonContentBody:"Мое местоположение"}),d.geoObjects.add(e.geoObjects),_(m)}).catch(e=>{console.error("Ошибка получения геолокации:",e),departments&&(m=[Number(departments.globalSettings.departments[0].lat),Number(departments.globalSettings.departments[0].lon)],d.setCenter(m,10)),notify("Информация о местоположении недоступна."),$("#error_load").text("Запрос на получение местоположения истек.")})}g.className="clear-input",g.innerHTML="&times;",g.onclick=()=>{r.value="",i.innerHTML="",g.style.display="none"},r.parentElement.appendChild(g),r.addEventListener("input",()=>{let e=r.value.trim();clearTimeout(u),f(e),e.length>=3&&y(),u=setTimeout(()=>{r.value.trim()===e&&e.length>=3?S(e).then(()=>{i.innerHTML=""}):i.innerHTML=""},800)}),n.addEventListener("click",()=>{h(),r.value="",i.innerHTML="",C(),e.style.display="flex",g.style.display="none",toggleBodyScroll(!0),tg.MainButton.hide(),tg.BackButton.show()}),o.addEventListener("click",()=>{console.log("click closeAddressModalBtn"),e.style.display="none",a.style.display="block",toggleBodyScroll(!1)}),"unknown"!=platform&&(o.style.display="none"),Telegram.WebApp.onEvent("backButtonClicked",function(){"flex"===e.style.display?(console.log("BackButton click addressModal flex"),e.style.display="none",a.style.display="none",tg.MainButton.setParams({text:"Продолжить",is_active:!0,is_visible:!0}),tg.BackButton.hide(),toggleBodyScroll(!1)):"flex"===t.style.display&&(console.log("BackButton click addressModal flex"),t.style.display="none",e.style.display="flex",tg.MainButton.setParams({is_visible:!1}))});let b=document.getElementById("promoCodeInput"),v=document.getElementById("clearpromoCodeInput");async function k(e){if(tg.MainButton.showProgress(),!obj.bot){console.error("No access token found. Please authorize first.");return}let t=getTokens(),n={method:"POST",headers:{Authorization:"Bearer "+t.accessToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"promocodes",code:e})},o="https://api.edatg.ru/webhook/v1/task/?bot_id="+obj.bot;try{let a=await fetch(o,n);if(401===a.status){if(console.log("Token expired, trying to refresh..."),token=await refreshAccessToken())n.headers.Authorization="Bearer "+token,a=await fetch(o,n);else{console.error("Unable to refresh token. Please log in again.");return}}if(a.ok){let r=await a.json();return r}console.error("Failed to fetch departments:",a.statusText)}catch(i){throw"AbortError"===i.name&&(notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.")),console.error("Error during the departments request:",i),i}finally{tg.MainButton.hideProgress()}}function E(){let e=document.getElementById("modal-overlay"),t=document.getElementById("promoPopup");if(t)e.style.display="block",t.classList.add("shown"),document.getElementById("inputPromoCode").focus();else{toggleBodyScroll(!0),e.style.display="block",e.innerHTML="";let n=document.createElement("div");n.classList.add("promo-backdrop"),e.appendChild(n);let o=`
                <div class="promo-popup" id="promoPopup">
                    <div class="promo-content">
                        <input type="text" id="inputPromoCode" placeholder="Введите промокод" style="">
                        <span class="clear-input" id="clearInputPromoCode" style="display: none;">\xd7</span>
                    </div>
                    <div id="promoError" style="color: red; display: none; margin-top: 5px;"></div> <!-- Теперь под promo-content -->
                </div>
            `;e.insertAdjacentHTML("beforeend",o),t=document.getElementById("promoPopup"),setTimeout(()=>{t.classList.add("shown")},50),document.getElementById("inputPromoCode").focus(),tg.MainButton.setParams({text:"Применить",is_visible:!0}),x(t,e),I()}}function I(){let e=document.getElementById("inputPromoCode"),t=document.getElementById("clearInputPromoCode"),n=document.getElementById("promoError");e.addEventListener("input",function(){t.style.display=e.value?"inline":"none",n.style.display="none"}),t.addEventListener("click",function(){e.value="",t.style.display="none",n.style.display="none"})}function x(e,t){let n=0,o=!1,a=document.querySelector(".promo-backdrop");e.addEventListener("touchstart",function(e){n=e.touches[0].clientY,o=!1},{passive:!0}),e.addEventListener("touchmove",function(t){let r=t.touches[0].clientY,i=r-n;i>10&&(o=!0,e.style.transform=`translateY(${i}px)`,a.style.opacity=Math.max(.7-i/300,0))},{passive:!0}),e.addEventListener("touchend",function(t){let r=t.changedTouches[0].clientY,i=r-n;o&&i>100?w():(e.style.transform="",a.style.opacity="")},{passive:!0})}function w(){let e=document.getElementById("promoPopup"),t=document.getElementById("modal-overlay");e&&(e.classList.remove("shown"),setTimeout(()=>{t&&(t.style.display="none",t.innerHTML="")},300)),toggleBodyScroll(!1),tg.MainButton.setParams({text:"Продолжить",is_active:!0,is_visible:!0})}function T(){let e=document.getElementById("promoCodeInput"),t=document.getElementById("clearpromoCodeInput");t.style.display=e.value?"inline":"none"}function B(){let e="custom#dark";ymaps.layer.storage.add(e,function e(){return new ymaps.Layer("https://core-renderer-tiles.maps.yandex.net/tiles?l=map&theme=dark&%c&%l&scale={{ scale }}")}),ymaps.mapType.storage.add(e,new ymaps.MapType("Dark Map",[e])),(d=new ymaps.Map(a,{center:[55.76,37.64],zoom:12,tilt:45,type:e,controls:[]})).options.set("maxZoom",21),d.options.set("minZoom",5),d.options.set("suppressMapOpenBlock",!0),d.controls.add("geolocationControl",{float:"none",position:{bottom:"150px",right:"30px"}}),d.controls.add("zoomControl",{size:"small",float:"none",position:{bottom:"300px",right:"30px"}}),c=ymaps.geocode,geolocation=ymaps.geolocation,(staticMarker={marker:function(){return document.getElementById("marker_drop")},createMarker:function(){document.getElementById("marker").style.display="flex",staticMarker.trackMovement()},clearMovingTimer:function(){staticMarker.clearMovingTimeoutId&&(clearTimeout(staticMarker.clearMovingTimeoutId),staticMarker.clearMovingTimeoutId=0)},startMovingTimer:function(e){staticMarker.clearMovingTimer(),staticMarker.clearMovingTimeoutId=setTimeout(e,500)},trackMovement:function(){d.events.add("actionbegin",function(e){"flex"===t.style.display&&("flex"===t.style.display?tg.MainButton.showProgress():tg.MainButton.hide(),s.textContent="",staticMarker.marker().classList.add("moving"),staticMarker.clearMovingTimer())}),d.events.add("actionend",function(e){"flex"===t.style.display&&staticMarker.startMovingTimer(function(){staticMarker.marker().classList.remove("moving");let e=d.getCenter().map(e=>Number(e).toFixed(6));if(console.log(p),p){let t=p.coords.map(e=>Number(e).toFixed(6)).join(","),n=e.join(",");p.details?.street&&t===n?(s.textContent=p.fullAddress,s.style.display="block"):(p.coords=e,M(e))}else console.log("selectedMarkerData нет данных",p),M(e);tg.MainButton.hideProgress()})})}}).createMarker()}function C(){let{historySelectedAddresses:e}=getStoredData();l.innerHTML="",e.forEach((e,t)=>{let n=document.createElement("div");n.className="confirmed-address-item",n.dataset.id=e.id;let o=document.createElement("div");o.className="confirmed-address-hint",o.textContent=e.short;let a=document.createElement("div");a.className="confirmed-address-subhint",a.textContent=`подъезд: ${e.rawDetails.entrance||"-"}, этаж: ${e.rawDetails.floor||"-"}, кв.: ${e.rawDetails.flat||"-"}`;let r=document.createElement("span");r.className="remove-address",r.innerHTML="&times;",r.onclick=e=>{e.stopPropagation(),A(t)},n.onclick=()=>{console.log("Обработчик клика для выбора адреса",e.full),console.log("Обработчик клика для выбора адреса",[e.lat,e.lon]),D(e.full,[e.lat,e.lon],e)},n.appendChild(o),n.appendChild(a),n.appendChild(r),l.appendChild(n)})}function A(e){let t=getStoredData();t.historySelectedAddresses.splice(e,1),saveStoredData(t),C()}function S(e){let t=d.getBounds(),n=`${t[0][1]},${t[0][0]},${t[1][1]},${t[1][0]}`,o=new URLSearchParams({apikey:"baff19b2-41d3-403f-9be2-25707be7ada1",text:e,lang:"ru",results:"15",bbox:n,highlight:"1",types:"biz,geo",print_address:"1"});return new Promise(()=>{fetch(`https://suggest-maps.yandex.ru/v1/suggest?${o}`).then(e=>e.json()).then(e=>{if(i.innerHTML="",e.results&&e.results.length>0)e.results.forEach(e=>{let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-hint",n.textContent=e.title.text;let o=document.createElement("div");o.className="suggestion-subhint",o.textContent=e.subtitle.text||"Информация не найдена",t.appendChild(n),t.appendChild(o),t.onclick=()=>{t.dataset.requested=!0,console.log("NEW suggestion: ",e),e.tags&&e.tags.includes("street")?r.value=e.title.text:D(e.address.formatted_address,null)},i.appendChild(t)});else{let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-error",n.textContent="Нет подсказок",t.appendChild(n),i.appendChild(t)}}).catch(e=>{console.error("Ошибка получения подсказок:",e);let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-error",n.textContent="Ошибка получения подсказок",t.appendChild(n),i.appendChild(t)})})}function D(e=null,t=null,n=null){console.log(`selectAddress | Переданые данные address:${e} coords:${t} details:${n}`),t?(n&&(p={fullAddress:e,coords:t,details:n}),s.textContent=e,s.style.display="block",_(p.coords)):c(e,{results:1,kind:"house"}).then(t=>{let n=t.geoObjects.get(0);n?(p={fullAddress:n.getAddressLine(),coords:n.geometry.getCoordinates(),details:L(n)||{}},s.textContent=e,s.style.display="block",_(p.coords)):P()}).catch(e=>{console.error("Ошибка при геокодировании:",e),P()})}function M(e){console.log("updateAddress | Переданые кординаты ",e),c(e,{results:1,kind:"house"}).then(n=>{let o=n.geoObjects.get(0);if(o&&o.getThoroughfare()){let a=o?o.getAddressLine():"Адрес не найден";p={fullAddress:o.getAddressLine(),coords:e,details:L(o)||{}},s.textContent=a,s.style.display="block","flex"===t.style.display&&tg.MainButton.setParams({text:"Сохранить",is_visible:!0})}else P()}).catch(e=>{console.error("Ошибка обновления адреса:",e),s.textContent="Ошибка получения адреса",s.style.display="block"})}function _(n){console.log("Перемещение к адресу с координатами:",n),a.style.display="block",e.style.display="none",t.style.display="flex";let o=d.container.getSize();console.log("Размер карты:",o[0],"x",o[1]),(0===o[0]||0===o[1])&&d.container.fitToViewport(),d.setCenter(n,17.5,{duration:800}),tg.MainButton.setParams({text:"Сохранить",is_active:!0,is_visible:!0})}function P(){s.textContent="Адрес не найден",s.style.display="block",tg.MainButton.setParams({text:"Уточнить адрес"})}function L(e){let t={full:e.getAddressLine(),short:e.properties.get("name"),districts:null,city:null,street:e.getThoroughfare(),house:null,entrance:null,building:null,country:e.getCountry(),areas:e.getAdministrativeAreas()||null,coordinates:e.geometry.getCoordinates()},n=e.properties.get("metaDataProperty.GeocoderMetaData.Address.Components");return n.forEach(e=>{switch(e.kind){case"locality":t.city=e.name;break;case"district":t.districts=e.name;break;case"house":t.house=e.name;break;case"entrance":t.entrance=e.name.match(/\d+/)?e.name.match(/\d+/)[0]:null;break;case"building":t.building=e.name}}),t}function j(){return"_"+Math.random().toString(36).substr(2,9)}function H(e,t){if(null==e||null==t)return!1;let n=e.split(",").slice(0,3).join(",").trim(),o=t.split(",").slice(0,3).join(",").trim();return n===o}async function z(){if(console.log("DATA selectedMarkerData: "+JSON.stringify(p)),!p)return tg.showAlert("Ошибка: данные адреса не найдены."),!1;{let{fullAddress:n,coords:o,details:a}=p,r=getStoredData(),{lastSelectedAddress:i,historySelectedAddresses:l}=r,s=l.findIndex(e=>H(e.full,n));-1!==s?(i=N(l[s],o,n,a),l[s]={...l[s],...i}):(i=O(o,a),l.push(i)),r.lastSelectedAddress=i,saveStoredData(r),U(i),e.style.display="none",t.style.display="none",toggleBodyScroll(!1),tg.BackButton.hide(),button_sendData()}return!0}function N(e,t,n,o){return{...e,lat:t[0],lon:t[1],full:n,short:o.short,coordinates:o?.coordinates??null,rawDetails:{...e.rawDetails,entrance:o.entrance||null}}}function O(e,t){return{id:j(),lat:e[0],lon:e[1],full:t.full,short:t.short,city:t.city||null,street:t.street||null,house:t.house||null,building:t.building||null,country:t.country||null,areas:t.areas||null,coordinates:t?.coordinates??null,rawDetails:{flat:null,floor:null,entrance:t.entrance||null,intercom:null,comment:null}}}function U(e){$('label[for="street"]').text(e.country+", "+e.city),streetInput.val(e.short||e.full),streetInput.val()&&streetInput.parent().addClass("has-value"),Object.entries({flat:"#flat",floor:"#floor",entrance:"#entrance",intercom:"#intercom",comment:"#order_place_comment"}).forEach(([t,n])=>{$(n).val(e.rawDetails[t])})}b.addEventListener("click",function(){E()}),b.addEventListener("input",function(){T()}),v.addEventListener("click",function(){b.value="",T()}),document.getElementById("modal-overlay").addEventListener("click",function(e){let t=document.getElementById("promoPopup"),n=document.getElementById("promo-code-input"),o=t?.contains(e.target)||n.contains(e.target);o||(w(),toggleBodyScroll(!1),tg.MainButton.setParams({text:"Продолжить",is_active:!0,is_visible:!0}))}),ymaps.ready(B),Telegram.WebApp.onEvent("mainButtonClicked",function(){let n=tg.MainButton.text;if(console.log("Click button ",n),"Продолжить"===n)confirmationSendData();else if("Сохранить"===n)tg.MainButton.showProgress(),z().then(e=>{console.log("Result:",e),tg.MainButton.hideProgress()}).catch(e=>{console.error("API error:",e),notify("К сожалению, адрес доставки не удалось сохранить.")});else if("Уточнить адрес"===n)e.style.display="flex",t.style.display="none";else if("Применить"===n){let o=document.getElementById("inputPromoCode").value;k(o).then(e=>{console.log("API response:",e);let t=document.getElementById("promoError");"error"===e.status?(t.textContent=e.error,t.style.display="block"):"ok"===e.status&&(document.getElementById("promoCodeInput").value=o,T(),w())}).catch(e=>{console.error("API error:",e)})}else console.warn("Неизвестный текст кнопки: ",n)}),[].forEach.call(document.querySelectorAll(".tel"),function(e){var t;function n(e){e.keyCode&&(t=e.keyCode),this.selectionStart<3&&e.preventDefault();var n="+7 (___) ___-__-__",o=0,a=n.replace(/\D/g,""),r=this.value.replace(/\D/g,""),i=n.replace(/[_\d]/g,function(e){return o<r.length?r.charAt(o++)||a.charAt(o):e});-1!=(o=i.indexOf("_"))&&(o<5&&(o=3),i=i.slice(0,o));var l=n.substr(0,this.value.length).replace(/_+/g,function(e){return"\\d{1,"+e.length+"}"}).replace(/[+()]/g,"\\$&");(!(l=RegExp("^"+l+"$")).test(this.value)||this.value.length<5||t>47&&t<58)&&(this.value=i),"blur"==e.type&&this.value.length<5&&(this.value="")}e.addEventListener("input",n,!0),e.addEventListener("focus",n,!0),e.addEventListener("blur",n,!0),e.addEventListener("keydown",n,!0)})});