var st_ver="0.160",tg=window.Telegram.WebApp,ball=document.getElementById("load-wrap"),notifier=document.getElementById("notifier");tg.expand(),tg.SettingsButton.show(),tg.BackButton.hide(),tg.enableClosingConfirmation(),Telegram.WebApp.onEvent("settingsButtonClicked",function(){window.location.reload(!0)});let theme=tg.themeParams,platform=tg.platform;btnOpen=document.getElementById("open_scanner"),btnOpen.style.backgroundColor=theme.button_color,btnOpen.style.color=theme.button_text_color;var tableId=null;function updateTableNumber(){return null!==tableId&&/^\d+$/.test(tableId)?($("#tablenumber").val(tableId),$("#tablenumber").text(" üçΩ –ù–æ–º–µ—Ä —Å—Ç–æ–ª–∞: "+tableId),tg.closeScanQrPopup(),void notify("–ù–æ–º–µ—Ä —Å—Ç–æ–ª–∞: ",tableId)):(console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π tableId:",tableId),tg.showAlert("–ù–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å qr-code"),!1)}tg.onEvent("qrTextReceived",async function({data:e}){var t=e.toString().toLowerCase();if(t.startsWith("http://")||t.startsWith("https://")){if(t.startsWith("https://tapper.cloud/")){let e=function(e){let t=e.indexOf("https://tapper.cloud/")+"https://tapper.cloud/".length,n=e.substring(t).split("/"),o=n[n.length-1].match(/\d+/);return o?o[0]:null}(t);return console.log("–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞:",e),tableId=e,updateTableNumber()}if(t.startsWith("https://eda.yandex.ru/inplace/menu?uuid=")){let e=function(e,t){let n=e.indexOf(t+"=");if(-1===n)return null;n+=t.length+1;let o=e.indexOf("&",n);return-1===o&&(o=e.length),e.substring(n,o)}(t,"uuid");console.log("–ó–Ω–∞—á–µ–Ω–∏–µ uuid:",e);let n="https://api.edatg.ru/webhook/tableId",o={uuid:e};!async function(){try{const e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify(o)});if(!e.ok)throw new Error("Network response was not ok");const t=await e.json();console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:",t),tableId=t.table_id,console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–π tableId:",tableId),updateTableNumber()}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞:",e)}}()}}else tg.showAlert("–ù–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å qr-code")}),btnOpen.addEventListener("click",function(){try{if("tdesktop"===platform)return void notify("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");tg.showScanQrPopup({text:tableId?`–ù–æ–º–µ—Ä —Å—Ç–æ–ª–∞: ${tableId}`:"–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ qr-code —Å—Ç–æ–ª–∞"},function(){return!1})}catch(e){console.error("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ",e.message)}});var selectedAddress,currentDepartmentId,departments={},$message=$("#message"),streetInput=$("#street"),selection="<option value='now'>‚åöÔ∏è –ë–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</option>";function preload(e){e.style.opacity=1;var t=setInterval(function(){e.style.opacity=e.style.opacity-.05,e.style.opacity<=.05&&(clearInterval(t),ball.style.display="none")},15)}function notify(e){notifier.className;notifier.className="warning show",$("#notifier").text(e),setTimeout(function(){notifier.className="warning"},1500)}function getMachineId(){try{let e=localStorage.getItem("uuid");return e||(e=self.UUID.generate(),localStorage.setItem("uuid",e)),e}catch(e){return console.log(e),"error"}}function zeroFill(e,t){return(t-=e.toString().length)>0?new Array(t+(/\./.test(e)?2:1)).join("0")+e:e+""}function getPersonalData(){const e=localStorage.getItem("personalData");return e?JSON.parse(e):{name:null,phone:null}}function getStoredData(){const e=localStorage.getItem("addressData");return e?JSON.parse(e):{historySelectedAddresses:[]}}function saveStoredData(e){localStorage.setItem("addressData",JSON.stringify(e))}function get_data_load(){const{name:e,phone:t}=getPersonalData(),{lastSelectedAddress:n,historySelectedAddresses:o}=getStoredData();if(e&&(console.log("–ù–∞–π–¥–µ–Ω: –∏–º—è"),$("#name").val(e)),t&&(console.log("–ù–∞–π–¥–µ–Ω: –¢–µ–ª–µ—Ñ–æ–Ω"),$("#phone").val(t)),n){n.full&&(console.log("–ù–∞–π–¥–µ–Ω: –∞–¥—Ä–µ—Å"),streetInput.val(n.short),streetInput.val()&&streetInput.parent().addClass("has-value"));const e={flat:"#flat",floor:"#floor",entrance:"#entrance",intercom:"#intercom",comment:"#order_place_comment"};Object.entries(e).forEach(([e,t])=>{n.rawDetails[e]&&(console.log(`–ù–∞–π–¥–µ–Ω: ${e}`),$(t).val(n.rawDetails[e]))})}}async function authorizeUser(){try{if(!obj.public||!obj.bot)throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.");const e={task:"auth"},t={method:"POST",headers:{"Content-Type":"application/json","X-Custom-Token":obj.public,"X-User-Info":getMachineId()},body:JSON.stringify(e)},n=new AbortController,o=n.signal,a="https://api.edatg.ru/webhook/v1/auth/?bot_id="+obj.bot,s=setTimeout(()=>{n.abort()},1e4);let r=await fetch(a,{...t,signal:o});if(clearTimeout(s),console.log(`HTTP Status Code: ${r.status}`),!r.ok){const e=await r.text();throw console.error("Authorization failed:",r.statusText),new Error(`–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${r.status} - ${e}`)}{const e=await r.json(),t=e.access_token,n=e.refresh_token;t&&n?(saveTokens(t,n,e.access_token_expires_at,e.refresh_token_expires_at),console.log("User authorized successfully!")):console.error("Failed to retrieve tokens from the server response."),console.log("Authorization successful.")}}catch(e){if(console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:",e),e.message.includes("401")){const e="–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ.";console.error("–û—à–∏–±–∫–∞ 401:",e),notify(e),$("#error_load").text(e)}else if("AbortError"===e.name){notify("–ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω –∏–∑-–∑–∞ —Ç–∞–π–º–∞—É—Ç–∞."),$("#error_load").text("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.")}else{const e="–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –°–∫–æ—Ä–æ –≤—Å—ë –ø–æ—á–∏–Ω–∏–º.\n –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å VPN –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.";notify(e),$("#error_load").text(e)}throw e}}async function refreshAccessToken(){try{const e=getTokens();if(!e.refreshToken)return console.log("No access token found, authorizing user..."),void await authorizeUser();const t=await fetch(`https://api.edatg.ru/webhook/v1/task/?bot_id=${obj.bot}`,{method:"POST",headers:{Authorization:"Bearer "+e.refreshToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"refresh_token"})});if(t.ok){const e=await t.json(),n=e.access_token;return n?(saveTokens(e.access_token,e.refresh_token,e.access_token_expires_at,e.refresh_token_expires_at),console.log("Token refreshed successfully!"),n):(console.error("Failed to retrieve new access token from the server response."),null)}console.error("Failed to refresh access token:",t.statusText),await authorizeUser()}catch(e){console.error("Error during token refresh:",e),await authorizeUser()}}async function getDepartments(){if(!obj.bot)return void console.error("No access token found. Please authorize first.");const e={method:"POST",headers:{Authorization:"Bearer "+getTokens().accessToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"departments"})},t="https://api.edatg.ru/webhook/v1/task/?bot_id="+obj.bot;try{let n=await fetch(t,e);if(401===n.status){if(console.log("Token expired, trying to refresh..."),token=await refreshAccessToken(),!token)return void console.error("Unable to refresh token. Please log in again.");e.headers.Authorization="Bearer "+token,n=await fetch(t,e)}if(n.ok){return await n.json()}console.error("Failed to fetch departments:",n.statusText)}catch(e){if("AbortError"===e.name){notify("–ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω –∏–∑-–∑–∞ —Ç–∞–π–º–∞—É—Ç–∞."),$("#error_load").text("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.")}throw console.error("Error during the departments request:",e),e}}function checkAndUpdateTimeSelection(e,t=40){console.log("checkAndUpdateTimeSelection:",e);var n=$("select").val();if("now"===n)return!1;var o=moment(n),a=moment().tz(e.time_zona);return console.log("Current time:",a.format("HH:mm")),console.log("Selected time:",o.format("HH:mm")),o.diff(a,"minutes")<=t&&(console.log("Difference in minutes:",o.diff(a,"minutes")),updateAvailableTimes(e.id),tg.showAlert("–í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è."),!0)}function updateAvailableTimes(e){currentDepartmentId=e,console.log("Updating times for department ID:",e);var t=departments.globalSettings.departments.find(function(t){return t.id===e});if(t){var n=t.workTime,o=moment().tz(t.time_zona),a=o.clone().add(40,"minutes"),s=(a.clone().startOf("day"),moment().add(1,"days").tz(t.time_zona));function r(e,t,n,a){var s=moment(n.from,"HH:mm"),r=moment(n.to,"HH:mm"),l=a?Math.max(e.hour()+1,n.fullDay?0:s.hour()+1):n.fullDay?0:s.hour()+1,i=n.fullDay?24:r.hour(),c="",d=!1;if(console.log(`Generating options for ${t} (${e.format("YYYY-MM-DD")})`),!d&&a){const e=r.diff(o,"minutes"),a=o.diff(s,"minutes");console.log("–î–æ –∑–∞–∫—Ä—ã—Ç–∏—è",e),console.log("–î–æ –æ—Ç–∫—Ä—ã—Ç–∏—è",a),n.fullDay||a>0&&e>10?(console.log(`Adding nearest time option for ${t}`),c+="<option value='now'>‚åöÔ∏è –ë–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</option>",d=!0):(e<=10&&tg.showAlert(`–î–æ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 10 –º–∏–Ω—É—Ç. –í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑ —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ c ${s.format("HH:mm")}.`),a<0&&tg.showAlert(`–ú—ã –Ω–∞—á–Ω—ë–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã —Å ${s.format("HH:mm YYYY-MM-DD")}.`))}for(var u=l;u<=i;u++){var m=zeroFill(u,2),p=e.clone().set({hour:u,minute:0,second:0});c+=`<option value='${p.format()}'>‚åöÔ∏è ${m}:00 ${t}</option>`,u<i&&(p.set({minute:30}),c+=`<option value='${p.format()}'>‚åöÔ∏è ${m}:30 ${t}</option>`)}return c}console.log("Adjusted time after adding 40 minutes:",a.format("YYYY-MM-DD HH:mm")),$("select").empty();var l="";l+=r(a,"–°–µ–≥–æ–¥–Ω—è",n[0],!0),l+=r(s,"–ó–∞–≤—Ç—Ä–∞",n[1],!1),$("select").html(l),checkAndUpdateTimeSelection(t)}}function confirmationSendData(){console.log("–í—ã–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π"),notify("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...");try{var e=$("#name")[0],t=e.value,n=$("#phone")[0],o=n.value;if(t.length<2)return e.focus(),e.reportValidity(),notify("–ò–º—è —É–∫–∞–∑–∞–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");if(o.length<18)return n.focus(),n.reportValidity(),notify("–¢–µ–ª–µ—Ñ–æ–Ω —É–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");if(localStorage.setItem("personalData",JSON.stringify({name:t,phone:o})),checkAndUpdateTimeSelection(departments.globalSettings.departments.find(function(e){return e.id===currentDepartmentId})))return;var a=$("input[name=shipping_type]:checked").val(),s=$("input[name=payment_type]:checked").val(),r=$("input[name=address_pickup]:checked").val(),l={platform:platform,guuid:getMachineId(),web_ver:st_ver,name:t,phone:o,shipping_type:null,payment_type:null,delivery_time:$("#delivery_time").val(),cutlery:$("#cutlery").val(),comment:$("#comment").val(),tablenumber:"",address:null};if("delivery"==a){l.shipping_type="üöõ –î–æ—Å—Ç–∞–≤–∫–∞",console.log("üöõ –î–æ—Å—Ç–∞–≤–∫–∞");const e=getStoredData();let{lastSelectedAddress:t,historySelectedAddresses:n}=e;if(null==t)return document.getElementById("street").click(),void notify("–í—ã–±–µ—Ä–∏—Ç–µ –£–ª–∏—Ü—É");t.rawDetails.flat=$("#flat").val(),t.rawDetails.floor=$("#floor").val(),t.rawDetails.entrance=$("#entrance").val(),t.rawDetails.intercom=$("#intercom").val(),t.rawDetails.comment=$("#order_place_comment").val(),e.lastSelectedAddress=t,saveStoredData(e),l.address={full_street:t.full,short:t.short,country:t.country,city:t.city,street:t.street,house:t.house,building:t.building,areas:t.areas,flat:t.rawDetails.flat,floor:t.rawDetails.floor,entrance:t.rawDetails.entrance,intercom:t.rawDetails.intercom,order_place_comment:t.rawDetails.comment,location:{lat:t.lat,lon:t.lon}},null==!l.address.full_street&&(document.getElementById("street").click(),notify("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–æ–≤–∞ —É–ª–∏—Ü—É."))}else if("takeout"==a){if(null==r)return notify("–í—ã–±–µ—Ä–∏—Ç–µ –≥–¥–µ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–∞—Ç—å –∑–∞–∫–∞–∑");l.address_pickup=r,l.shipping_type="üèÉ –ù–∞–≤—ã–Ω–æ—Å",console.log("üèÉ –ù–∞–≤—ã–Ω–æ—Å")}else{if("inside"!=a)return console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏: ",a),notify("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏: ",a);if(null==r)return notify("–í—ã–±–µ—Ä–∏—Ç–µ –≥–¥–µ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–∞—Ç—å –∑–∞–∫–∞–∑");l.address_pickup=r,l.shipping_type="üçΩ –í –∑–∞–≤–µ–¥–µ–Ω–∏–∏",l.tablenumber=$("#tablenumber").val(),console.log("üçΩ –í –∑–∞–≤–µ–¥–µ–Ω–∏–∏")}l.payment_type=s,tg.sendData(JSON.stringify(l))}catch(e){console.log("–û—à–∏–±–∫–∞",e),$("#error_t").text("–û—à–∏–±–∫–∞: "+e),notify("–û—à–∏–±–∫–∞: "+e)}}function button_sendData(){tg.MainButton.setParams({text:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",color:"#32746a",text_color:"#FFFFFF",is_active:!0,is_visible:!0})}list_payment={paysbp:{alt:"–°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)",title:"–°–ë–ü",img:"image/sbp_icons.png"},paycard:{alt:"–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞",title:"–ë–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π –æ–Ω–ª–∞–π–Ω",img:"image/card_icon.png"},paycash:{alt:"–ù–∞–ª–∏—á–Ω—ã–º–∏ –∏–ª–∏ –∫–∞—Ä—Ç–æ–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏",title:"–ù–∞–ª–∏—á–Ω—ã–º–∏ –∏–ª–∏ –∫–∞—Ä—Ç–æ–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏",img:"image/money_icon.png"}},validParams=["bot","public"];const params=window.location.search.substring(1).split("&"),filteredParams=params.filter(e=>([name]=e.split("="),validParams.includes(name))),obj={};for(const e of filteredParams){const[t,n]=e.split("=");obj[t]=n}if(obj.bot&&obj.public){localStorage.setItem(obj.bot,obj.public);const e=new URL(window.location);e.searchParams.delete("public"),window.history.replaceState({},document.title,e.toString())}else if(obj.bot){const e=localStorage.getItem(obj.bot);e?obj.public=e:console.error("–ü–∞—Ä–∞–º–µ—Ç—Ä public –Ω–µ –Ω–∞–π–¥–µ–Ω.")}else console.error("–ü–∞—Ä–∞–º–µ—Ç—Ä bot –Ω–µ –Ω–∞–π–¥–µ–Ω.");function DeliveryOptions(e){const t=document.getElementById("delivery-options-container"),n=document.getElementById("delivery-address"),o=document.getElementById("personal-details"),a=document.getElementById("pickup-location"),s=document.getElementById("table-number");function r(){const e=Array.from(t.children);e.sort((e,t)=>{const n=e.classList.contains("unavailable"),o=t.classList.contains("unavailable");return n&&!o?1:!n&&o?-1:0}),e.forEach(e=>{t.appendChild(e)})}function l(){if(!t)return void console.error("Delivery options container not found in the document.");t.innerHTML="",Object.keys(e).forEach(l=>{const i=e[l],c=function(e,t,n,o){const a=document.createElement("label");a.classList.add("delivery-option"),o||a.classList.add("unavailable"),a.id=`option-item-${e}`;const s=document.createElement("input");s.classList.add("option-input"),s.id=`option-${e}`,s.name="shipping_type",s.type="radio",s.value=e,o||(s.disabled=!0);const r=document.createElement("div");r.classList.add("option-content");const l=document.createElement("div");l.classList.add("delivery-text"),l.textContent=t;const i=document.createElement("div");return i.classList.add("delivery-time"),i.textContent=n,r.appendChild(l),r.appendChild(i),a.appendChild(s),a.appendChild(r),a}(l,i.title,i.description,i.available);t.appendChild(c),c.querySelector(".option-input").addEventListener("change",function(){!function(){n.style.display="none",o.style.display="none",a.style.display="none",s.style.display="none",t.querySelectorAll(".option-input").forEach(e=>e.parentElement.classList.remove("selected"));const r=t.querySelector(".option-input:checked");if(r){const t=r.value;e[t].available&&(r.parentElement.classList.add("selected"),"delivery"===t?(o.style.display="block",n.style.display="block"):"takeout"===t?(o.style.display="block",a.style.display="block"):"inside"===t&&(o.style.display="block",a.style.display="block",s.style.display="block"))}}(),r()})}),r();const l=t.querySelector(".option-input:not([disabled])");l&&(l.checked=!0,l.dispatchEvent(new Event("change")))}window.updateDeliveryOptions=function(t){Object.keys(e).forEach(n=>{t.hasOwnProperty(n)&&(e[n]=t[n])}),l()},l()}function loadParams(e){try{var t=getMachineId();guuid_platform=" GUID: "+t,$("#guuid").text(guuid_platform);let a=e.globalSettings.payment_methods;a=null==a||void 0===a?["paysbp"]:0===a.length?["paysbp"]:a.split(",");let s=["method1","method2"];a.length>0&&(s=a[0]);let r="";a.forEach(function(e){r+=`<div class='radio-item'>\n                        <input class='radio-list' type='radio' name='payment_type' id='${e}' value='${e}' required ${e===s?"checked":""}>\n                        <label for='${e}'>\n                            <img src='${list_payment[e].img}' alt='${list_payment[e].alt}' class='checkout-payment__slider-image'>\n                            ${list_payment[e].title}\n                        </label>\n                    </div>`}),$(".payment-list").html(r),DeliveryOptions(e.globalSettings.delivery_methods),$(document).ready(function(){$(".delivery-option").hover(function(){var e=$(".delivery-container").scrollLeft(),t=$(this).position().left;$(".delivery-container").animate({scrollLeft:e+t},120)})});var n="";for(var o in e.globalSettings.departments)n+="<div class='radio-item'>",n+="<input class='radio-list' type='radio' name='address_pickup' id='"+e.globalSettings.departments[o].id+"' value='"+e.globalSettings.departments[o].id+"' required>",n+="<label for='"+e.globalSettings.departments[o].id+"'>",n+="<img src='image/map_icon.png' alt='"+e.globalSettings.departments[o].address+"' class='checkout-payment__slider-image'>",n+=e.globalSettings.departments[o].address,n+="</label>",n+="</div>";$(".departments").html(n),console.log("Departments:",e.globalSettings.departments),console.log("Selected Department ID:",""),$('input[type="radio"][name="address_pickup"]').change(function(){var t=$(this).val(),n=e.globalSettings.departments.find(function(e){return e.id===parseInt(t)});n?(console.log("Selected Department:",n),updateAvailableTimes(n.id),notify("–ò–∑–º–µ–Ω–∏–ª–æ—Å—å –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏.")):console.log("Department not found for ID:",t)}),$("select").change(function(){checkAndUpdateTimeSelection(e.globalSettings.departments.find(function(e){return e.id===currentDepartmentId}))}),$(document).ready(function(){e.globalSettings.departments.length>0&&updateAvailableTimes(e.globalSettings.departments[0].id)})}catch(e){return console.log(e),notify("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∞–π—Ç–∞"),void $("#error_load").text("–û—à–∏–±–∫–∞: "+e)}$("#ver").text(" ver: "+st_ver),get_data_load()}function getCookie(e){const t=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){let o=n[e];for(;" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(t))return o.substring(t.length,o.length)}return null}function setCookie(e,t,n){let o="";if(n){const e=new Date;e.setTime(e.getTime()+24*n*60*60*1e3),o="; expires="+e.toUTCString()}document.cookie=e+"="+(t||"")+o+"; path=/"}function saveTokens(e,t,n,o){setCookie("access_token",e,7),setCookie("refresh_token",t,30),setCookie("access_token_expires_at",n,7),setCookie("refresh_token_expires_at",o,30)}function eraseCookie(e){document.cookie=e+"=; Max-Age=-99999999;"}function getTokens(){return{accessToken:getCookie("access_token"),refreshToken:getCookie("refresh_token"),accessTokenExpiresAt:getCookie("access_token_expires_at"),refreshTokenExpiresAt:getCookie("refresh_token_expires_at")}}async function checkTokenStatus(e){const t={method:"POST",headers:{"Content-Type":"application/json","X-User-Info":getMachineId(),Authorization:"Bearer "+e},body:JSON.stringify({task:"profile"})};try{const e=await fetch(`https://api.edatg.ru/webhook/v1/task/?bot_id=${obj.bot}`,t),n=await e.json();e.ok?console.log("Token is valid. User:",n.user):(console.log("Token is invalid or expired, refreshing..."),await refreshAccessToken())}catch(e){if("AbortError"===e.name){notify("–ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω –∏–∑-–∑–∞ —Ç–∞–π–º–∞—É—Ç–∞."),$("#error_load").text("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.")}throw console.error("Error checking token status:",e),e}}async function checkAuthorization(){const e=getTokens();return!e.accessToken||hasTokenExpired(e.refreshTokenExpiresAt)?await authorizeUser():hasTokenExpired(e.accessTokenExpiresAt)?(console.log("Access token is missing or expired, authorizing user..."),await refreshAccessToken()):(console.log("Access token is valid, checking token status..."),void await checkTokenStatus(e.accessToken))}function hasTokenExpired(e){if(!e)return!0;const t=new Date(e);return new Date>=t}window.onload=async function(){await checkAuthorization(),getDepartments().then(e=>{console.log("API response:",e),departments=e,loadParams(e),preload(ball),button_sendData()}).catch(e=>{console.error("API error:",e)})},window.addEventListener("DOMContentLoaded",function(){[].forEach.call(document.querySelectorAll(".tel"),function(e){var t;function n(e){e.keyCode&&(t=e.keyCode),this.selectionStart<3&&e.preventDefault();var n="+7 (___) ___-__-__",o=0,a=n.replace(/\D/g,""),s=this.value.replace(/\D/g,""),r=n.replace(/[_\d]/g,function(e){return o<s.length?s.charAt(o++)||a.charAt(o):e});-1!=(o=r.indexOf("_"))&&(o<5&&(o=3),r=r.slice(0,o));var l=n.substr(0,this.value.length).replace(/_+/g,function(e){return"\\d{1,"+e.length+"}"}).replace(/[+()]/g,"\\$&");(!(l=new RegExp("^"+l+"$")).test(this.value)||this.value.length<5||t>47&&t<58)&&(this.value=r),"blur"==e.type&&this.value.length<5&&(this.value="")}e.addEventListener("input",n,!0),e.addEventListener("focus",n,!0),e.addEventListener("blur",n,!0),e.addEventListener("keydown",n,!0)})}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("addressModal"),t=document.getElementById("mapModal"),n=document.getElementById("open-modal"),o=document.getElementById("close-address-modal"),a=document.getElementById("map"),s=document.getElementById("address-input"),r=document.getElementById("suggestions"),l=document.getElementById("confirmed-addresses"),i=document.getElementById("confirm-btn"),c=document.getElementById("current-address");let d,u,m;let p=null,g=null;const f=document.createElement("span");function h(e){e?(document.documentElement.setAttribute("data-hide-scroll",""),document.body.setAttribute("data-hide-scroll","")):(document.documentElement.removeAttribute("data-hide-scroll"),document.body.removeAttribute("data-hide-scroll"))}function y(){const{historySelectedAddresses:e}=getStoredData();l.innerHTML="",e.forEach((e,t)=>{const n=document.createElement("div");n.className="confirmed-address-item",n.dataset.id=e.id;const o=document.createElement("div");o.className="confirmed-address-hint",o.textContent=e.short;const a=document.createElement("div");a.className="confirmed-address-subhint",a.textContent=`–ø–æ–¥—ä–µ–∑–¥: ${e.rawDetails.entrance||"-"}, —ç—Ç–∞–∂: ${e.rawDetails.floor||"-"}, –∫–≤.: ${e.rawDetails.flat||"-"}`;const s=document.createElement("span");s.className="remove-address",s.innerHTML="&times;",s.onclick=(e=>{e.stopPropagation(),function(e){const t=getStoredData();t.historySelectedAddresses.splice(e,1),saveStoredData(t),y()}(t)}),n.onclick=(()=>{b(e.full,[e.lat,e.lon])}),n.appendChild(o),n.appendChild(a),n.appendChild(s),l.appendChild(n)})}function b(e,t){t?k((p={fullAddress:e,coords:t,details:{}}).coords):u(e).then(e=>{const t=e.geoObjects.get(0);t?k((p={fullAddress:t.getAddressLine(),description:t.properties.getAll().description,coords:t.geometry.getCoordinates(),details:w(t)||{}}).coords):_()}).catch(e=>{console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏:",e),_()})}function k(n){console.log("–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫ –∞–¥—Ä–µ—Å—É —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:",n),d.setCenter(n,18),a.style.display="block","unknown"===platform?(i.style.display="block",i.textContent="–Ø –∑–¥–µ—Å—å"):tg.MainButton.setParams({text:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",color:"#32746a",text_color:"#FFFFFF",is_active:!0,is_visible:!0}),e.style.display="none",t.style.display="flex",d.container.fitToViewport();const o=d.container.getSize();console.log("–†–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã:",o[0],"x",o[1])}function v(e){console.log("updateAddress | –ü–µ—Ä–µ–¥–∞–Ω—ã–µ –∫–æ—Ä–¥–∏–Ω–∞—Ç—ã ",e),u(e).then(e=>{const t=e.geoObjects.get(0);if(console.log(t),t&&t.getThoroughfare()){const e=t?t.getAddressLine():"–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";p={fullAddress:t.getAddressLine(),coords:t.geometry.getCoordinates(),details:w(t)||{}},c.textContent=e,c.style.display="block","unknown"===platform?i.textContent="–Ø –∑–¥–µ—Å—å":tg.MainButton.setParams({text:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"})}else _()}).catch(e=>{console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:",e),c.textContent="–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞",c.style.display="block"})}function _(){c.textContent="–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω",c.style.display="block","unknown"===platform?(i.style.display="block",i.textContent="–£—Ç–æ—á–Ω–∏—Ç—å –∞–¥—Ä–µ—Å"):tg.MainButton.setParams({text:"–£—Ç–æ—á–Ω–∏—Ç—å –∞–¥—Ä–µ—Å"})}function w(e){const t={full:e.getAddressLine(),short:e.properties.get("name"),districts:null,city:null,street:e.getThoroughfare(),house:null,entrance:null,building:null,country:e.getCountry(),areas:e.getAdministrativeAreas()||null};return e.properties.get("metaDataProperty.GeocoderMetaData.Address.Components").forEach(e=>{switch(e.kind){case"locality":t.city=e.name;break;case"district":t.districts=e.name;break;case"house":t.house=e.name;break;case"entrance":t.entrance=e.name.match(/\d+/)?e.name.match(/\d+/)[0]:null;break;case"building":t.building=e.name}}),t}function T(e,t){return e.split(",").slice(0,3).join(",").trim()===t.split(",").slice(0,3).join(",").trim()}function x(){if(console.log("DATA selectedMarkerData: "+JSON.stringify(p)),e.style.display="none",t.style.display="none",p){const{fullAddress:n,coords:o,details:a}=p,s=getStoredData();let{lastSelectedAddress:r,historySelectedAddresses:l}=s;r&&T(r.full,n)?(r.lat=o[0],r.lon=o[1],r.full=n,r.short=a.short,r.rawDetails.entrance=a.entrance||null):r={id:"_"+Math.random().toString(36).substr(2,9),lat:o[0],lon:o[1],full:a.full,short:a.short,city:a.city||null,street:a.street||null,house:a.house||null,building:a.building||null,country:a.country||null,areas:a.areas||null,rawDetails:{flat:null,floor:null,entrance:a.entrance||null,intercom:null,comment:null}},s.lastSelectedAddress=r;const i=l.findIndex(e=>e.id===r.id||T(e.full,n));-1!==i?l[i]={...l[i],...r}:l.push(r),saveStoredData(s),streetInput.val(r.short),streetInput.val()&&streetInput.parent().addClass("has-value");const c={flat:"#flat",floor:"#floor",entrance:"#entrance",intercom:"#intercom",comment:"#order_place_comment"};Object.entries(c).forEach(([e,t])=>{r.rawDetails[e]&&(console.log(`–ù–∞–π–¥–µ–Ω: ${e}`),$(t).val(r.rawDetails[e]))}),e.style.display="none",t.style.display="none",h(!1),tg.BackButton.hide(),button_sendData()}else tg.showAlert("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")}f.className="clear-input",f.innerHTML="&times;",f.onclick=(()=>{s.value="",r.innerHTML="",f.style.display="none"}),s.parentElement.appendChild(f),s.addEventListener("input",()=>{const e=s.value.trim();clearTimeout(m),e.length>0?f.style.display="inline":f.style.display="none",m=setTimeout(()=>{e.length>=3?function(e){const t=d.getBounds(),n=`${t[0][1]},${t[0][0]},${t[1][1]},${t[1][0]}`,o=new URLSearchParams({apikey:"baff19b2-41d3-403f-9be2-25707be7ada1",text:e,lang:"ru",results:"15",bbox:n,highlight:"1",types:"biz,geo",print_address:"1"});fetch(`https://suggest-maps.yandex.ru/v1/suggest?${o}`).then(e=>e.json()).then(e=>{console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:",e),r.innerHTML="",e.results&&e.results.length>0?e.results.forEach(e=>{const t=document.createElement("div");t.className="suggestion-item";const n=document.createElement("div");n.className="suggestion-hint",n.textContent=e.title.text;const o=document.createElement("div");o.className="suggestion-subhint",o.textContent=e.subtitle.text||"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",t.appendChild(n),t.appendChild(o),t.onclick=(()=>{if(!t.dataset.requested)if(t.dataset.requested=!0,console.log("NEW suggestion: ",e),e.tags&&e.tags.includes("street"))s.value=e.title.text;else{const t=e.address&&e.address.coords;t?b(null,t):b(e.address.formatted_address,null)}}),r.appendChild(t)}):r.innerHTML="<p>–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–æ–∫</p>"}).catch(e=>{console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫:",e),r.innerHTML="<p>–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫</p>"})}(e):r.innerHTML=""},800)}),n.addEventListener("click",()=>{g?console.log("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã: ",g):navigator.geolocation?(console.log("Geolocation –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"),navigator.geolocation.getCurrentPosition(e=>{g=[e.coords.latitude,e.coords.longitude],console.log("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã:",g),k(g)},e=>{console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:",e.message),departments&&(g=[departments.globalSettings.departments[0].lat,departments.globalSettings.departments[0].lon],d.setCenter(g,12))},{timeout:1e3})):(departments&&(g=[departments.globalSettings.departments[0].lat,departments.globalSettings.departments[0].lon],d.setCenter(g,12)),console.warn("Geolocation –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ")),s.value="",r.innerHTML="",y(),e.style.display="flex",f.style.display="none",h(!0),tg.MainButton.hide(),tg.BackButton.show()}),o.addEventListener("click",()=>{console.log("click closeAddressModalBtn"),e.style.display="none",a.style.display="block",h(!1)}),"unknown"!=platform&&(o.style.display="none"),Telegram.WebApp.onEvent("backButtonClicked",function(){"flex"===e.style.display?(console.log("BackButton click addressModal flex"),e.style.display="none",a.style.display="none",tg.MainButton.setParams({text:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",is_active:!0,is_visible:!0}),tg.BackButton.hide(),h(!1)):"flex"===t.style.display&&(console.log("BackButton click addressModal flex"),t.style.display="none",e.style.display="flex",tg.MainButton.hide())}),ymaps.ready(function(){ymaps.layer.storage.add("custom#dark",function(){return new ymaps.Layer("https://core-renderer-tiles.maps.yandex.net/tiles?l=map&theme=dark&%c&%l&scale={{ scale }}")}),ymaps.mapType.storage.add("custom#dark",new ymaps.MapType("Dark Map",["custom#dark"])),(d=new ymaps.Map(a,{center:[55.76,37.64],zoom:12,tilt:45,type:"custom#dark",controls:[]})).options.set("maxZoom",21),d.options.set("minZoom",5),d.options.set("suppressMapOpenBlock",!0),d.controls.add("geolocationControl",{float:"none",position:{bottom:"150px",right:"30px"}}),d.controls.add("zoomControl",{size:"small",float:"none",position:{bottom:"300px",right:"30px"}}),u=ymaps.geocode,geolocation=ymaps.geolocation,staticMarker={marker:function(){return document.getElementById("marker_drop")},createMarker:function(){document.getElementById("marker").style.display="flex",staticMarker.trackMovement()},clearMovingTimer:function(){staticMarker.clearMovingTimeoutId&&(clearTimeout(staticMarker.clearMovingTimeoutId),staticMarker.clearMovingTimeoutId=0)},startMovingTimer:function(e){staticMarker.clearMovingTimer(),staticMarker.clearMovingTimeoutId=setTimeout(e,500)},coordsAreEqual:function(e,t,n=5e-5){return!(!e||!t)&&(Math.abs(e[0]-t[0])<n&&Math.abs(e[1]-t[1])<n)},trackMovement:function(){d.events.add("actionbegin",function(e){staticMarker.marker().classList.add("moving"),c.textContent="",staticMarker.clearMovingTimer()}),d.events.add("actionend",function(e){console.log(e.get("newZoom"));var t=d.action.getCurrentState();console.log(t,t.zoom,t.globalPixelCenter),staticMarker.startMovingTimer(function(){staticMarker.marker().classList.remove("moving");const e=d.getCenter();if(console.log(p),p){const t=p.coords.join(","),n=e.join(",");t!==n&&(p.coords=e,v(e))}else console.log("selectedMarkerData –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö",p),v(e)})})}},staticMarker.createMarker()}),i.addEventListener("click",()=>{"–Ø –∑–¥–µ—Å—å"===i.textContent?x():"–£—Ç–æ—á–Ω–∏—Ç—å –∞–¥—Ä–µ—Å"===i.textContent&&(e.style.display="flex",t.style.display="none")}),Telegram.WebApp.onEvent("mainButtonClicked",function(){const n=tg.MainButton.text;console.log("Click button ",n),"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"===n?confirmationSendData():"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"===n?x():"–£—Ç–æ—á–Ω–∏—Ç—å –∞–¥—Ä–µ—Å"===n?(e.style.display="flex",t.style.display="none"):console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏: ",n)})});