var currentDepartmentId,st_ver="0.185",tg=window.Telegram.WebApp,notifier=document.getElementById("notifier");const ERROR_SEND_INTERVAL=12e4;tg.expand(),tg.SettingsButton.show(),tg.BackButton.hide(),tg.enableClosingConfirmation();let mainButtonVisible=!0;Telegram.WebApp.onEvent("settingsButtonClicked",function(){mainButtonVisible?tg.MainButton.hide():tg.MainButton.show(),mainButtonVisible=!mainButtonVisible});let theme=tg.themeParams,platform=tg.platform;(btnOpen=document.getElementById("open_scanner")).style.backgroundColor=theme.button_color,btnOpen.style.color=theme.button_text_color;var tableId=null;let isTimeBeingUpdated=!1;function updateTableNumber(){if(null!==tableId&&/^\d+$/.test(tableId)){$("#tablenumber").val(tableId),$("#tablenumber").text(" \uD83C\uDF7D Номер стола: "+tableId),tg.closeScanQrPopup(),notify("Номер стола: ",tableId);return}return console.error("Некорректный tableId:",tableId),tg.showAlert("Не смог распознать qr-code"),!1}tg.onEvent("qrTextReceived",async function({data:e}){var t,n=e.toString().toLowerCase();if(n.startsWith("http://")||n.startsWith("https://")){if(n.startsWith("https://tapper.cloud/")){let o,a,r,i=(o=(t=n).indexOf("https://tapper.cloud/")+21,(r=(a=t.substring(o).split("/"))[a.length-1].match(/\d+/))?r[0]:null);return console.log("Последняя цифра:",i),tableId=i,updateTableNumber()}if(n.startsWith("https://eda.yandex.ru/inplace/menu?uuid=")){let s=function e(t,n){let o=t.indexOf(n+"=");if(-1===o)return null;o+=n.length+1;let a=t.indexOf("&",o);return -1===a&&(a=t.length),t.substring(o,a)}(n,"uuid");console.log("Значение uuid:",s);let l={uuid:s};async function d(){try{let e=await fetch("https://api.edatg.ru/webhook/tableId",{method:"POST",headers:{"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify(l)});if(!e.ok)throw Error("Network response was not ok");let t=await e.json();return console.log("Ответ сервера:",t),tableId=t.table_id,console.log("Полученный tableId:",tableId),updateTableNumber()}catch(n){console.error("Ошибка при выполнении запроса:",n)}}d()}}else tg.showAlert("Не смог распознать qr-code")}),btnOpen.addEventListener("click",function(){try{if("tdesktop"===platform){notify("Сканирование недоступно");return}tg.showScanQrPopup({text:tableId?`Номер стола: ${tableId}`:"Отсканируйте qr-code стола"},function(){return!1})}catch(e){console.error("Произошла ошибка: ",e.message)}});var departments={},$message=$("#message"),streetInput=$("#street"),selection="<option value='now'>⌚️ Ближайшее время</option>";function notify(e){notifier.className="warning show",$("#notifier").text(e),setTimeout(function(){notifier.className="warning"},1500)}function logError(e,t){let n=Date.now(),o=`lastErrorTime_${t}`,a=localStorage.getItem(o);if(a&&n-a<12e4){console.warn(`Too many logs of type '${t}', skipping this one.`);return}localStorage.setItem(o,n),fetch("https://edatg.ru/logs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,guuid:getMachineId(),platform:platform,logType:t})}).catch(e=>{console.error("Failed to send error log:",e)})}list_payment={paysbp:{alt:"СБП (Система быстрых платежей)",title:"СБП",img:"image/sbp_icons.png"},paycard:{alt:"Банковская карта",title:"Банковской картой онлайн",img:"image/card_icon.png"},paycash:{alt:"Наличными или картой при получении",title:"Наличными или картой при получении",img:"image/money_icon.png"}};var loaderWrap={element:document.getElementById("load-wrap"),showLoader:function(){this.element.style.display="flex",this.element.style.opacity=1},hideLoader:function(){var e=setInterval(()=>{this.element.style.opacity-=.05,this.element.style.opacity<=.05&&(clearInterval(e),this.element.style.display="none")},15)}};function getMachineId(){try{let e=localStorage.getItem("uuid");return e||(e=self.UUID.generate(),localStorage.setItem("uuid",e)),e}catch(t){return console.log(t),"error"}}function zeroFill(e,t){return(t-=e.toString().length)>0?Array(t+(/\./.test(e)?2:1)).join("0")+e:e+""}function getPersonalData(){let e=localStorage.getItem("personalData");return e?JSON.parse(e):{name:null,phone:null}}function getStoredData(){let e=localStorage.getItem("addressData");return e?JSON.parse(e):{historySelectedAddresses:[]}}function saveStoredData(e){localStorage.setItem("addressData",JSON.stringify(e))}function get_data_load(){let{name:e,phone:t}=getPersonalData(),{lastSelectedAddress:n,historySelectedAddresses:o}=getStoredData();e&&$("#name").val(e),t&&$("#phone").val(t),n&&($('label[for="street"]').text(n.country+", "+n.city),streetInput.val(n.short||n.full),streetInput.val()&&streetInput.parent().addClass("has-value"),Object.entries({flat:"#flat",floor:"#floor",entrance:"#entrance",intercom:"#intercom",comment:"#order_place_comment"}).forEach(([e,t])=>{n.rawDetails[e]&&(console.log(`Найден: ${e}`),$(t).val(n.rawDetails[e]))}))}async function authorizeUser(){try{if(!filteredParams.public||!filteredParams.bot)throw Error("Недостаточно данных для выполнения запроса.");let e={method:"POST",headers:{"Content-Type":"application/json","X-Custom-Token":filteredParams.public,"X-User-Info":getMachineId()},body:JSON.stringify({task:"auth"})},t="https://api.edatg.ru/webhook/v1/auth/?bot_id="+filteredParams.bot,n=await fetch(t,{...e});if(console.log(`HTTP Status Code: ${n.status}`),n.ok){let o=await n.json(),a=o.access_token,r=o.refresh_token;a&&r?(saveTokens(a,r,o.access_token_expires_at,o.refresh_token_expires_at),console.log("User authorized successfully!")):console.error("Failed to retrieve tokens from the server response."),console.log("Authorization successful.")}else{let i=await n.text();throw console.error("Authorization failed:",n.statusText),Error(`Ошибка запроса: ${n.status} - ${i} | ${n.statusText}`)}}catch(s){if(console.error("Ошибка запроса:",s),logError(s.message,"authorizeUser"),s.message.includes("401")){let l="Сессия истекла. Пожалуйста, авторизуйтесь заново.";console.error("Ошибка 401:",l),notify(l)}else if("AbortError"===s.name)notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.");else{let d="Упс, что-то пошло не так. Скоро всё починим.\n Попробуйте отключить VPN и повторить попытку.";notify(d),$("#error_load").text(d)}throw s}}async function refreshAccessToken(){try{let e=getTokens();if(!e.refreshToken){console.log("No access token found, authorizing user..."),await authorizeUser();return}let t=await fetch(`https://api.edatg.ru/webhook/v1/task/?bot_id=${filteredParams.bot}`,{method:"POST",headers:{Authorization:"Bearer "+e.refreshToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"refresh_token"})});if(t.ok){let n=await t.json(),o=n.access_token;if(o)return saveTokens(n.access_token,n.refresh_token,n.access_token_expires_at,n.refresh_token_expires_at),console.log("Token refreshed successfully!"),o;return console.error("Failed to retrieve new access token from the server response."),null}console.error("Failed to refresh access token:",t.statusText),await authorizeUser()}catch(a){console.error("Error during token refresh:",a),await authorizeUser()}}async function getDepartments(){if(!filteredParams.bot){console.error("No access token found. Please authorize first.");return}let e=getTokens(),t={method:"POST",headers:{Authorization:"Bearer "+e.accessToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"departments"})},n="https://api.edatg.ru/webhook/v1/task/?bot_id="+filteredParams.bot;try{let o=await fetch(n,t);if(401===o.status){if(console.log("Token expired, trying to refresh..."),token=await refreshAccessToken())t.headers.Authorization="Bearer "+token,o=await fetch(n,t);else{console.error("Unable to refresh token. Please log in again.");return}}if(o.ok){let a=await o.json();return a}{let r=await o.text();throw Error(`Ошибка запроса: ${o.status} - ${r} | ${o.statusText}`)}}catch(i){throw notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку."),console.error("Error during the departments request:",i),logError(i.message,"getDepartments"),i}}async function getAddress(e){if(!filteredParams.bot){console.error("No access token found. Please authorize first.");return}let t=getTokens(),n={method:"POST",headers:{Authorization:"Bearer "+t.accessToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"address",coords:e})},o="https://api.edatg.ru/webhook/v1/task/?bot_id="+filteredParams.bot;try{let a=await fetch(o,n);if(a.ok){let r=await a.json();return r}console.error("Failed to fetch departments:",a.statusText)}catch(i){throw"AbortError"===i.name&&(notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.")),console.error("Error during the departments request:",i),i}finally{console.log("finally getAddress")}}const checkDeliveryZone=async(e,t=!0)=>{try{let n=await getAddress(e);if(console.log("API getAddress response:",n),"error"===n.status||!n.status.delivery_zone_found)return!1;return n}catch(o){return console.error("API error during delivery zone check:",o),!1}};function checkAndUpdateTimeSelection(e){var t=$("select").val();if("now"===t)return!1;moment.tz.setDefault(e.time_zona),moment.locale("ru");var n=moment(t),o=moment(),a="delivery"===$("input[name=shipping_type]:checked").val()?e.eta:0,r=e.cooking_time;if(isTimeBeingUpdated)return console.log("Время уже обновляется, предотвращаем повторное обновление."),!1;if(console.log("Current time:",o.format("HH:mm")),console.log("Selected time:",n.format("HH:mm")),n.isBefore(o))return console.log("Выбранное время раньше текущего времени, невозможно выбрать."),!1;var i=n.diff(o,"minutes");return console.log("Difference in minutes:",i),i<=a+r&&(console.log("Выбранное время меньше или равно времени на приготовление и доставку."),isTimeBeingUpdated=!0,updateAvailableTimes(e.id),tg.showAlert("Выбранное время больше не доступно, пожалуйста, выберите новое время."),isTimeBeingUpdated=!1,!0)}function updateAvailableTimes(e){currentDepartmentId=e;var t=departments.globalSettings.departments.find(function(t){return t.id===e});if(t){moment.tz.setDefault(t.time_zona);var n=t.workTime,o=moment(),a=$("input[name=shipping_type]:checked").val(),r="delivery"===a?t.eta:0,i=t.cooking_time,s=r+i,l="delivery"===a?30:15,d=o.clone().add(s,"minutes"),c=Math.ceil(d.minutes()/l)*l;d.minutes(c).seconds(0),$("select").empty();let u=function e(t){let n=t.daysOptions&&t.daysOptions.length>0?t.daysOptions:[{offset:0,label:"Сегодня",isActive:!0},{offset:1,label:"Завтра",isActive:!0}],o=n.filter(e=>e.isActive).map(e=>moment().add(e.offset,"days").tz(t.time_zona)),a=n.find(e=>e.additionalDays)?.additionalDays||0;for(let r=0;r<a;r++)o.push(moment().add(o.length,"days").tz(t.time_zona));return o}(t);var p=function e(t,n){let o=new Map(n.map(e=>[e.day,e])),a="",r=!1,c=null;return t.forEach(function(e){let n=e.isoWeekday(),u=o.get(n);if(!u){console.warn(`Нет данных о времени работы для дня недели: ${n}`);return}let p=e.diff(moment().startOf("day"),"days"),g=0===p?"Сегодня":1===p?"Завтра":e.format("dd, D MMMM"),m=u.fullDay?e.clone().startOf("day"):moment(u.from,"HH:mm").set({year:e.year(),month:e.month(),date:e.date()}),f=u.fullDay?e.clone().endOf("day"):moment(u.to,"HH:mm").set({year:e.year(),month:e.month(),date:e.date()});if(d.isBefore(m)){d=m.clone().add(s,"minutes");let h=Math.ceil(d.minutes()/l)*l;d.minutes(h).seconds(0)}if(c){let y=o.get(c.isoWeekday());if(y){let v=moment(y.to,"HH:mm").set({year:c.year(),month:c.month(),date:c.date()});if(y.fullDay&&v.endOf("day"),v){let k=m.diff(v,"minutes");k<=s&&(d=e.clone().startOf("day").add(l,"minutes"))}}}if(0===p&&!r){let b=moment(),E=f.diff(b,"minutes"),w=b.diff(m,"minutes");if(u.fullDay||w>=0&&E>i)a+=`<option value='now'>⌚️ Ближайшее время</option>`,r=!0;else{if(E<=i){let T=t.find(e=>1===e.diff(moment().startOf("day"),"days")),I=T?o.get(T.isoWeekday()):null;if(T&&I){let A=moment(I.from,"HH:mm").set({year:T.year(),month:T.month(),date:T.date()});tg.showAlert(`Доставить сегодня уже не успеем, но вы можете оформить заказ на завтра, начиная с ${A.format("HH:mm")}.`)}}w<0&&tg.showAlert(`Мы начнём принимать заказы с ${m.format("HH:mm DD-MM-YYYY")}.`);return}}let x=d.clone();for(;x.isBefore(f)||x.isSame(f);){let B=x.format("HH:mm"),C=x.format();if(a+=`<option value='${C}'>⌚️ ${B} ${g}</option>`,x.add(l,"minutes"),x.isAfter(f)){let M=f.format("HH:mm"),D=f.format();a+=`<option value='${D}'>⌚️ ${M} ${g}</option>`;break}if(x.diff(m,"minutes")>f.diff(m,"minutes")){console.error("Exceeded calculated iterations, exiting loop to prevent infinite loop");break}}c=e}),a}(u,n);$("select").html(p),checkAndUpdateTimeSelection(t)}}async function confirmationSendData(){console.log("Вызывает кнопку продолжить: проверка данных на заполнение полей"),notify("Загрузка формы...");try{tg.MainButton.showProgress();var e=$("#name")[0],t=e.value,n=$("#phone")[0],o=n.value;if(t.length<2)return e.focus(),e.reportValidity(),notify("Имя указано некорректно");if(o.length<18)return n.focus(),n.reportValidity(),notify("Телефон указан некорректно");localStorage.setItem("personalData",JSON.stringify({name:t,phone:o}));var a=departments.globalSettings.departments.find(function(e){return e.id===currentDepartmentId});if(checkAndUpdateTimeSelection(a))return;var r=$("input[name=shipping_type]:checked").val(),i=$("input[name=payment_type]:checked").val(),s=$("input[name=address_pickup]:checked").val(),l={platform:platform,guuid:getMachineId(),web_ver:st_ver,name:t,phone:o,shipping_type:null,payment_type:null,delivery_time:$("#delivery_time").val(),cutlery:$("#cutlery").val(),comment:$("#comment").val(),promocode:{code:$("#promoCodeInput").val()},tablenumber:"",address:null};if("delivery"==r){l.shipping_type="delivery",console.log("\uD83D\uDE9B Доставка");let d=getStoredData(),{lastSelectedAddress:c,historySelectedAddresses:u}=d;if(null==c){document.getElementById("street").click(),notify("Выберите Улицу");return}let p=await checkDeliveryZone([c.lat,c.lon]);if(!p){document.getElementById("street").click(),notify("Сюда доставки нет");return}c.rawDetails.flat=$("#flat").val(),c.rawDetails.floor=$("#floor").val(),c.rawDetails.entrance=$("#entrance").val(),c.rawDetails.intercom=$("#intercom").val(),c.rawDetails.comment=$("#order_place_comment").val(),d.lastSelectedAddress=c;let g=u.findIndex(e=>e.id===c.id);-1!==g?u[g]={...u[g],...c}:u.push(c),saveStoredData(d),l.address={full_street:c.full,short:c.short,country:c.country,city:c.city,street:c.street,house:c.house,building:c.building,areas:c.areas,coordinates:c?.coordinates??null,flat:c.rawDetails.flat,floor:c.rawDetails.floor,entrance:c.rawDetails.entrance,intercom:c.rawDetails.intercom,order_place_comment:c.rawDetails.comment,location:{lat:c.lat,lon:c.lon}},null==!l.address.full_street&&(document.getElementById("street").click(),notify("Что-то пошло не так, выберите снова улицу."))}else if("takeout"==r){if(null==s)return notify("Выберите где хотите забрать заказ");l.address_pickup=s,l.shipping_type="takeout"}else{if("inside"!=r)return console.warn("Неизвестный тип доставки: ",r),notify("Неизвестный тип доставки: ",r);if(null==s)return notify("Выберите где хотите забрать заказ");l.address_pickup=s,l.shipping_type="inside",l.tablenumber=$("#tablenumber").val(),console.log("\uD83C\uDF7D В заведении")}l.payment_type=i,tg.sendData(JSON.stringify(l))}catch(m){console.log("Ошибка",m),$("#error_t").text("Ошибка: "+m),notify("Ошибка: "+m)}finally{tg.MainButton.hideProgress()}}function button_sendData(){tg.MainButton.setParams({text:"Продолжить",color:"#32746a",text_color:"#FFFFFF",is_active:!0,is_visible:!0})}function DeliveryOptions(e){let t=document.getElementById("delivery-options-container"),n=document.getElementById("delivery-address"),o=document.getElementById("personal-details"),a=document.getElementById("pickup-location"),r=document.getElementById("table-number");function i(){let e=Array.from(t.children);e.sort((e,t)=>{let n=e.classList.contains("unavailable"),o=t.classList.contains("unavailable");return n&&!o?1:!n&&o?-1:0}),e.forEach(e=>{t.appendChild(e)})}function s(){if(!t){console.error("Delivery options container not found in the document.");return}t.innerHTML="",Object.keys(e).forEach(s=>{let l=e[s],d=function e(t,n,o,a){let r=document.createElement("label");r.classList.add("delivery-option"),a||r.classList.add("unavailable"),r.id=`option-item-${t}`;let i=document.createElement("input");i.classList.add("option-input"),i.id=`option-${t}`,i.name="shipping_type",i.type="radio",i.value=t,a||(i.disabled=!0);let s=document.createElement("div");s.classList.add("option-content");let l=document.createElement("div");l.classList.add("delivery-text"),l.textContent=n;let d=document.createElement("div");return d.classList.add("delivery-time"),d.textContent=o,s.appendChild(l),s.appendChild(d),r.appendChild(i),r.appendChild(s),r}(s,l.title,l.description,l.available);t.appendChild(d);let c=d.querySelector(".option-input");c.addEventListener("change",function(){(function i(){n.style.display="none",o.style.display="none",a.style.display="none",r.style.display="none";let s=t.querySelectorAll(".option-input");s.forEach(e=>e.parentElement.classList.remove("selected"));let l=t.querySelector(".option-input:checked");if(l){let d=l.value,c=e[d];c.available&&(l.parentElement.classList.add("selected"),"delivery"===d?(o.style.display="block",n.style.display="block"):"takeout"===d?(o.style.display="block",a.style.display="block"):"inside"===d&&(o.style.display="block",a.style.display="block",r.style.display="block"))}})(),i()})}),i();let s=t.querySelector(".option-input:not([disabled])");s&&(s.checked=!0,s.dispatchEvent(new Event("change")))}s(),function e(){let t=$(".delivery-container");$(".delivery-option").hover(function(){let e=t.scrollLeft(),n=t.width(),o=$(this),a=o.position().left,r=o.outerWidth();(a<0||a+r>n)&&t.animate({scrollLeft:e+a},120)})}(),window.updateDeliveryOptions=function t(n){Object.keys(e).forEach(t=>{n.hasOwnProperty(t)&&(e[t]=n[t])}),s()}}function loadParams(e){try{var t=getMachineId();guuid_platform=" GUID: "+t,$("#guuid").text(guuid_platform);let n=e.globalSettings.payment_methods,o=n;o=null==o||void 0===o?["paysbp"]:0===o.length?["paysbp"]:o.split(",");let a=["method1","method2"];o.length>0&&(a=o[0]);let r="";o.forEach(function(e){let t=e===a?"checked":"";r+=`<div class='radio-item'>
                        <input class='radio-list' type='radio' name='payment_type' id='${e}' value='${e}' required ${t}>
                        <label for='${e}'>
                            <img src='${list_payment[e].img}' alt='${list_payment[e].alt}' class='checkout-payment__slider-image'>
                            ${list_payment[e].title}
                        </label>
                    </div>`}),$(".payment-list").html(r);let i=e.globalSettings.delivery_methods;DeliveryOptions(i);var s="";for(var l in e.globalSettings.departments)s+="<div class='radio-item'>",s+="<input class='radio-list' type='radio' name='address_pickup' id='"+e.globalSettings.departments[l].id+"' value='"+e.globalSettings.departments[l].id+"' required>",s+="<label for='"+e.globalSettings.departments[l].id+"'>",s+="<img src='image/map_icon.png' alt='"+e.globalSettings.departments[l].address+"' class='checkout-payment__slider-image'>",s+=e.globalSettings.departments[l].address,s+="</label>",s+="</div>";function d(e,t){return(t-=e.toString().length)>0?Array(t+(/\./.test(e)?2:1)).join("0")+e:e+""}$(".departments").html(s),console.log("Departments:",e.globalSettings.departments),console.log("Selected Department ID:",""),$('input[type="radio"][name="address_pickup"]').change(function(){var t=$(this).val(),n=e.globalSettings.departments.find(function(e){return e.id===parseInt(t)});n?(console.log("Selected Department:",n),updateAvailableTimes(n.id),notify("Изменилось время доставки.")):console.log("Department not found for ID:",t)}),$("select").change(function(){var t=e.globalSettings.departments.find(function(e){return e.id===currentDepartmentId});checkAndUpdateTimeSelection(t)}),$(document).ready(function(){!function t(){if(e.globalSettings.departments.length>0){var n=e.globalSettings.departments[0].id;updateAvailableTimes(n),$("input[name=shipping_type]").change(function(){updateAvailableTimes(n)})}}()})}catch(c){console.log(c),notify("Ошибка загрузка сайта"),$("#error_load").text("Ошибка: "+c);return}$("#ver").text(" ver: "+st_ver+"|"+tg.version),get_data_load()}function getCookie(e){let t=e+"=",n=document.cookie.split(";");for(let o=0;o<n.length;o++){let a=n[o];for(;" "===a.charAt(0);)a=a.substring(1,a.length);if(0===a.indexOf(t))return a.substring(t.length,a.length)}return null}function setCookie(e,t,n){let o="";if(n){let a=new Date;a.setTime(a.getTime()+864e5*n),o="; expires="+a.toUTCString()}document.cookie=e+"="+(t||"")+o+"; path=/"}function saveTokens(e,t,n,o){setCookie("access_token",e,7),setCookie("refresh_token",t,30),setCookie("access_token_expires_at",n,7),setCookie("refresh_token_expires_at",o,30)}function eraseCookie(e){document.cookie=e+"=; Max-Age=-99999999;"}function getTokens(){return{accessToken:getCookie("access_token"),refreshToken:getCookie("refresh_token"),accessTokenExpiresAt:getCookie("access_token_expires_at"),refreshTokenExpiresAt:getCookie("refresh_token_expires_at")}}async function checkTokenStatus(e){let t={method:"POST",headers:{"Content-Type":"application/json","X-User-Info":getMachineId(),Authorization:"Bearer "+e},body:JSON.stringify({task:"profile"})};try{let n=await fetch(`https://api.edatg.ru/webhook/v1/task/?bot_id=${filteredParams.bot}`,t),o=await n.json();n.ok?console.log("Token is valid. User:",o.user):(console.log("Token is invalid or expired, refreshing..."),await refreshAccessToken())}catch(a){throw logError(a.message,"checkTokenStatus"),"AbortError"===a.name&&(notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.")),console.error("Error checking token status:",a),a}}async function checkAuthorization(){let e=getTokens();return!e.accessToken||hasTokenExpired(e.refreshTokenExpiresAt)?await authorizeUser():hasTokenExpired(e.accessTokenExpiresAt)?(console.log("Access token is missing or expired, authorizing user..."),await refreshAccessToken()):void(console.log("Access token is valid, checking token status..."),await checkTokenStatus(e.accessToken))}function hasTokenExpired(e){if(!e)return!0;let t=new Date(e),n=new Date;return n>=t}function toggleBodyScroll(e){e?(document.documentElement.setAttribute("data-hide-scroll",""),document.body.setAttribute("data-hide-scroll","")):(document.documentElement.removeAttribute("data-hide-scroll"),document.body.removeAttribute("data-hide-scroll"))}async function MainStart(){try{await checkAuthorization();let e=await getDepartments();console.log("API response:",e),departments=e,loadParams(e),button_sendData(),loaderWrap.hideLoader()}catch(t){console.error("API error:",t)}}document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("addressModal"),t=document.getElementById("mapModal"),n=document.getElementById("open-modal"),o=document.getElementById("user-location"),a=document.getElementById("close-address-modal"),r=document.getElementById("map"),i=document.getElementById("address-input"),s=document.getElementById("suggestions"),l=document.getElementById("confirmed-addresses"),d=document.getElementById("current-address"),c,u=null,p=document.createElement("span");function g(e){p.style.display=e.length>0?"inline":"none"}function m(){if(!s.querySelector(".loading-hint")){s.innerHTML="";for(let e=0;e<2;e++){let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-hint loading-hint";let o=document.createElement("div");o.className="suggestion-subhint loading-subhint",t.appendChild(n),t.appendChild(o),s.appendChild(t)}}}p.className="clear-input",p.innerHTML="&times;",p.onclick=()=>{i.value="",s.innerHTML="",p.style.display="none"},i.parentElement.appendChild(p),i.addEventListener("input",()=>{let e=i.value.trim();clearTimeout(c),g(e),e.length>=3&&m(),c=setTimeout(()=>{i.value.trim()===e&&e.length>=3?x(e).then(()=>{s.innerHTML=""}):s.innerHTML=""},800)}),n.addEventListener("click",async()=>{await T.init(),console.log("mapHandler map: ",T.map),console.log("mapHandler geolocation:",T.geolocation),i.value="",s.innerHTML="",I(),e.style.display="flex",p.style.display="none",toggleBodyScroll(!0),tg.MainButton.hide(),tg.BackButton.show()}),o.addEventListener("click",async()=>{let e=await T.getUserLocation();if(r.style.display="block",t.style.display="flex",e)return T.moveToAddress(e);T.moveToAddress(T.userCoords,zoom=12)}),a.addEventListener("click",()=>{console.log("click closeAddressModalBtn"),e.style.display="none",r.style.display="block",toggleBodyScroll(!1)}),"unknown"!=platform&&(a.style.display="none"),Telegram.WebApp.onEvent("backButtonClicked",function(){"flex"===e.style.display?(console.log("BackButton click addressModal flex"),e.style.display="none",r.style.display="none",tg.MainButton.setParams({text:"Продолжить",is_active:!0,is_visible:!0}),tg.BackButton.hide(),toggleBodyScroll(!1)):"flex"===t.style.display&&(console.log("BackButton click addressModal flex"),t.style.display="none",e.style.display="flex",tg.MainButton.setParams({is_visible:!1}))});let f=document.getElementById("promoCodeInput"),h=document.getElementById("clearpromoCodeInput");async function y(e){if(tg.MainButton.showProgress(),!filteredParams.bot){console.error("No access token found. Please authorize first.");return}let t=getTokens(),n={method:"POST",headers:{Authorization:"Bearer "+t.accessToken,"Content-Type":"application/json","X-User-Info":getMachineId()},body:JSON.stringify({task:"promocodes",code:e})},o="https://api.edatg.ru/webhook/v1/task/?bot_id="+filteredParams.bot;try{let a=await fetch(o,n);if(401===a.status){if(console.log("Token expired, trying to refresh..."),token=await refreshAccessToken())n.headers.Authorization="Bearer "+token,a=await fetch(o,n);else{console.error("Unable to refresh token. Please log in again.");return}}if(a.ok){let r=await a.json();return r}console.error("Failed to fetch departments:",a.statusText)}catch(i){throw"AbortError"===i.name&&(notify("Запрос прерван из-за таймаута."),$("#error_load").text("Превышено время ожидания ответа от сервера. Попробуйте повторить попытку.")),console.error("Error during the departments request:",i),i}finally{tg.MainButton.hideProgress()}}function v(){let e=document.getElementById("modal-overlay"),t=document.getElementById("promoPopup");if(t)e.style.display="block",t.classList.add("shown"),document.getElementById("inputPromoCode").focus();else{toggleBodyScroll(!0),e.style.display="block",e.innerHTML="";let n=document.createElement("div");n.classList.add("promo-backdrop"),e.appendChild(n);let o=`
                <div class="promo-popup" id="promoPopup">
                    <div class="promo-content">
                        <input type="text" id="inputPromoCode" placeholder="Введите промокод" style="">
                        <span class="clear-input" id="clearInputPromoCode" style="display: none;">\xd7</span>
                    </div>
                    <div id="promoError" style="color: red; display: none; margin-top: 5px;"></div> <!-- Теперь под promo-content -->
                </div>
            `;e.insertAdjacentHTML("beforeend",o),t=document.getElementById("promoPopup"),setTimeout(()=>{t.classList.add("shown")},50),document.getElementById("inputPromoCode").focus(),tg.MainButton.setParams({text:"Применить",is_visible:!0}),b(t,e),k()}}function k(){let e=document.getElementById("inputPromoCode"),t=document.getElementById("clearInputPromoCode"),n=document.getElementById("promoError");e.addEventListener("input",function(){t.style.display=e.value?"inline":"none",n.style.display="none"}),t.addEventListener("click",function(){e.value="",t.style.display="none",n.style.display="none"})}function b(e,t){let n=0,o=!1,a=document.querySelector(".promo-backdrop");e.addEventListener("touchstart",function(e){n=e.touches[0].clientY,o=!1},{passive:!0}),e.addEventListener("touchmove",function(t){let r=t.touches[0].clientY,i=r-n;i>10&&(o=!0,e.style.transform=`translateY(${i}px)`,a.style.opacity=Math.max(.7-i/300,0))},{passive:!0}),e.addEventListener("touchend",function(t){let r=t.changedTouches[0].clientY,i=r-n;o&&i>100?E():(e.style.transform="",a.style.opacity="")},{passive:!0})}function E(){let e=document.getElementById("promoPopup"),t=document.getElementById("modal-overlay");e&&(e.classList.remove("shown"),setTimeout(()=>{t&&(t.style.display="none",t.innerHTML="")},300)),toggleBodyScroll(!1),tg.MainButton.setParams({text:"Продолжить",is_active:!0,is_visible:!0})}function w(){let e=document.getElementById("promoCodeInput"),t=document.getElementById("clearpromoCodeInput");t.style.display=e.value?"inline":"none"}f.addEventListener("click",function(){v()}),f.addEventListener("input",function(){w()}),h.addEventListener("click",function(){f.value="",w()}),document.getElementById("modal-overlay").addEventListener("click",function(e){let t=document.getElementById("promoPopup"),n=document.getElementById("promo-code-input"),o=t?.contains(e.target)||n.contains(e.target);o||(E(),toggleBodyScroll(!1),tg.MainButton.setParams({text:"Продолжить",is_active:!0,is_visible:!0}))});let T={map:null,geocoder:null,geolocation:null,isLoaded:null,userCoords:null,extractCoordinates:function(e){let t=[];return e.forEach(e=>{e.geo_lat&&e.geo_lon?t.push([parseFloat(e.geo_lat),parseFloat(e.geo_lon)]):e.address&&e.address.location&&t.push([e.address.location.lat,e.address.location.lon])}),t},getYmaps:async function(){return new Promise((e,t)=>{$.getScript("https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=5f9ee64c-4f9e-4ad9-bdca-a4a3d6ed2d43",(n,o,a)=>{200===a.status?(console.log("Загрузка карты была выполнена."),ymaps.ready(()=>{this.initMap(),this.isLoaded=!0,e()})):t(Error("Не удалось загрузить карту"))})})},initMap:async function(e=12){if(console.log("Проверка загрузки карты"),this.map)return;console.log("Загружаем карту"),this.geocoder=ymaps.geocode,this.geolocation=ymaps.geolocation,void 0!==tg.LocationManager?!0===tg.LocationManager.isInited&&tg.LocationManager.isLocationAvailable&&tg.LocationManager.isAccessRequested&&!tg.LocationManager.isAccessGranted&&await this.getUserLocation().then(e=>{T.userCoords=e,T.openmap=!0,console.log("Координаты центра:",T.userCoords)}).catch(e=>{console.error("Ошибка при получении координат пользователя:",e)}):await this.getUserLocation().then(e=>{T.userCoords=e,T.openmap=!0,console.log("Координаты центра:",T.userCoords)}).catch(e=>{console.error("Ошибка при получении координат пользователя:",e)}),!T.userCoords&&departments?.globalSettings?.departments?.length>0&&(T.userCoords=[Number(departments.globalSettings.departments[0].lat),Number(departments.globalSettings.departments[0].lon)]),console.log("Координаты центра:",T.userCoords);let t="custom#dark";ymaps.layer.storage.add(t,function e(){return new ymaps.Layer("https://core-renderer-tiles.maps.yandex.net/tiles?l=map&theme=dark&%c&%l&scale={{ scale }}")}),ymaps.mapType.storage.add(t,new ymaps.MapType("Dark Map",[t])),this.map=new ymaps.Map(r,{center:this.userCoords||[55.76,37.64],zoom:e,tilt:45,type:t,controls:[]});let n=new ResizeObserver(()=>{this.map&&this.map.container.fitToViewport()});n.observe(r),this.map.options.set("maxZoom",21),this.map.options.set("minZoom",5),this.map.options.set("suppressMapOpenBlock",!0),this.map.controls.add("geolocationControl",{float:"none",position:{bottom:"150px",right:"30px"}}),this.map.controls.add("zoomControl",{size:"small",float:"none",position:{bottom:"300px",right:"30px"}}),console.log("Карта инициализирована."),this.initStaticMarker()},getUserLocation:async function(){if(console.log("Получает место положения пользователя."),void 0!==tg.LocationManager&&tg.LocationManager.isLocationAvailable){if(tg.LocationManager.isAccessRequested&&!tg.LocationManager.isAccessGranted){for(notify("Доступ к геолокации не предоставлен. Открываем настройки."),await new Promise(e=>setTimeout(e,1500)),console.warn("Открываем настройки для предоставления доступа к геолокации."),tg.LocationManager.openSettings(),await new Promise(e=>setTimeout(e,2500)),console.log("Ожидание завершения настроек...");!tg.isActive;)await new Promise(e=>setTimeout(e,500));if(!tg.LocationManager.isAccessGranted)return notify("Доступ к геолокации не предоставлен."),null}return new Promise((e,t)=>{tg.LocationManager.getLocation(t=>{t?(console.log("Получены данные о местоположении:",t),e([t.latitude,t.longitude])):(console.warn("Доступ к геолокации не предоставлен."),e(null))})})}try{let e=await T.geolocation.get({provider:"browser",autoReverseGeocode:!0,timeout:5e3});return console.log("Получены новые координаты:",e.geoObjects.position.map(Number)),e.geoObjects.position.map(Number)}catch(t){return console.error("Ошибка получения координат через browser:",t),null}},initStaticMarker:function(){document.getElementById("marker").style.display="flex",this.trackMovement()},marker:function(){return document.getElementById("marker_drop")},clearMovingTimer:function(){this.clearMovingTimeoutId&&(clearTimeout(this.clearMovingTimeoutId),this.clearMovingTimeoutId=0)},startMovingTimer:function(e){this.clearMovingTimer(),this.clearMovingTimeoutId=setTimeout(e,500)},currentAddress:function(e){d.textContent=e,d.style.display="block","Загрузка..."!==e&&""!==e&&tg.MainButton.hideProgress()},updateAddress:function(e){console.log("updateAddress | Переданные координаты",e),checkDeliveryZone(e).then(n=>{n?this.geocoder(e,{results:10,kind:"house"}).then(o=>{let a=o.geoObjects.get(0);if(a&&a.getThoroughfare()){let r=a.getAddressLine();u={delivery_zone_found:n,fullAddress:r,coords:e,details:C(a)||{}},T.currentAddress(r),"flex"===t.style.display&&tg.MainButton.setParams({text:"Сохранить",is_visible:!0})}else B()}).catch(e=>{console.error("Ошибка обновления адреса:",e),T.currentAddress("Ошибка получения адреса")}):B(!0)}).catch(e=>{console.error("Ошибка проверки зоны доставки:",e),B()})},selectAddress:function(e=null,t=null,n=null){console.log(`selectAddress | Переданные данные address: ${e} coords: ${t} details: ${n}`);let o=(e,t,n,o="")=>{t&&Array.isArray(t)&&2===t.length&&(u={fullAddress:e,coords:t,details:n||{}},street_exists=!0,(null==o||u.details?.street===null||u.details?.street===void 0)&&(street_exists=!1),this.map.events.remove("actionend",this.actionEndHandler),this.moveToAddress(t),T.currentAddress("Загрузка..."),checkDeliveryZone(t).then(t=>{t?(street_exists?tg.MainButton.setParams({text:"Сохранить",is_active:!0,is_visible:!0}):tg.MainButton.setParams({text:"Уточнить адрес",is_active:!0,is_visible:!0}),T.currentAddress(e)):B(!0)}).catch(e=>{console.error("Ошибка при проверке зоны доставки:",e),B()}),setTimeout(()=>{T.marker().classList.remove("moving"),this.map.events.add("actionend",this.actionEndHandler)},805))};t?o(e,t,n):this.geocoder(e,{results:10,kind:"house"}).then(e=>{let t=e.geoObjects.get(0);t?o(t.getAddressLine(),t.geometry.getCoordinates(),C(t),t.getThoroughfare()):B()}).catch(e=>{console.error("Ошибка при геокодировании:",e),B()})},checkDiscrepancies:async function(e){let t=this.map.getCenter().map(e=>Number(e).toFixed(6)).join(","),n=Array.isArray(e)?e.map(e=>Number(e).toFixed(6)).join(","):"Invalid coordinates";return n!==t},trackMovement:function(){this.actionBeginHandler=()=>{"flex"===t.style.display&&(tg.MainButton.showProgress(),T.currentAddress(""),T.marker().classList.add("moving"),T.clearMovingTimer())},this.actionEndHandler=()=>{"flex"===t.style.display&&T.startMovingTimer(function(){T.currentAddress("Загрузка..."),T.marker().classList.remove("moving");let e=T.map.getCenter().map(e=>Number(e).toFixed(6));u?!u.details?.street||T.checkDiscrepancies(u.coords)?(u.coords=e,T.updateAddress(e)):T.currentAddress(u.fullAddress):T.updateAddress(e)})},this.map.events.add("actionbegin",this.actionBeginHandler),this.map.events.add("actionend",this.actionEndHandler)},moveToAddress:function(n,o=17.5){console.log("Перемещение к адресу с координатами:",n),r.style.display="block",e.style.display="none",t.style.display="flex";let a=this.map.container.getSize();console.log("Размер карты:",a[0],"x",a[1]),(0===a[0]||0===a[1])&&this.map.container.fitToViewport(),this.checkDiscrepancies(n)&&this.map.setCenter(n,o,{duration:800})},init:async function(){if(!this.isLoaded)try{loaderWrap.showLoader(),tg.LocationManager.init(),await this.getYmaps()}finally{loaderWrap.hideLoader()}}};function I(){let{historySelectedAddresses:e}=getStoredData();l.innerHTML="",e.forEach((e,t)=>{let n=document.createElement("div");n.className="confirmed-address-item",n.dataset.id=e.id;let o=document.createElement("div");o.className="confirmed-address-hint",o.textContent=e.short;let a=document.createElement("div");a.className="confirmed-address-subhint",a.textContent=`подъезд: ${e.rawDetails.entrance||"-"}, этаж: ${e.rawDetails.floor||"-"}, кв.: ${e.rawDetails.flat||"-"}`;let r=document.createElement("span");r.className="remove-address",r.innerHTML="&times;",r.onclick=e=>{e.stopPropagation(),A(t)},n.onclick=()=>{console.log("Обработчик клика для выбора адреса",e.full),console.log("Обработчик клика для выбора адреса",[e.lat,e.lon]),T.selectAddress(e.full,[e.lat,e.lon],e)},n.appendChild(o),n.appendChild(a),n.appendChild(r),l.appendChild(n)})}function A(e){let t=getStoredData();t.historySelectedAddresses.splice(e,1),saveStoredData(t),I()}function x(e){let t=T.map.getBounds(),n=`${t[0][1]},${t[0][0]},${t[1][1]},${t[1][0]}`,o=new URLSearchParams({apikey:"baff19b2-41d3-403f-9be2-25707be7ada1",text:e,lang:"ru",results:"15",bbox:n,highlight:"1",types:"biz,geo",print_address:"1"});return new Promise(()=>{fetch(`https://suggest-maps.yandex.ru/v1/suggest?${o}`).then(e=>e.json()).then(e=>{if(s.innerHTML="",e.results&&e.results.length>0)e.results.forEach(e=>{let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-hint",n.textContent=e.title.text;let o=document.createElement("div");o.className="suggestion-subhint",o.textContent=e.subtitle?.text||e.distance?.text||"Информация не найдена",t.appendChild(n),t.appendChild(o),t.onclick=()=>{t.dataset.requested=!0,console.log("NEW suggestion: ",e),e.tags&&e.tags.includes("street")?i.value=e.title.text:T.selectAddress(e.address.formatted_address)},s.appendChild(t)});else{let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-error",n.textContent="Нет подсказок",t.appendChild(n),s.appendChild(t)}}).catch(e=>{console.error("Ошибка получения подсказок:",e);let t=document.createElement("div");t.className="suggestion-item";let n=document.createElement("div");n.className="suggestion-error",n.textContent="Ошибка получения подсказок",t.appendChild(n),s.appendChild(t)})})}function B(e=!1){d.textContent=e?"Сюда доставки нет":"Адрес не найден",d.style.display="block",tg.MainButton.setParams({text:"Уточнить адрес",is_active:!0,is_visible:!0})}function C(e){let t={full:e.getAddressLine(),short:e.properties.get("name"),districts:null,city:null,street:e.getThoroughfare(),house:null,entrance:null,building:null,country:e.getCountry(),areas:e.getAdministrativeAreas()||null,coordinates:e.geometry.getCoordinates()},n=e.properties.get("metaDataProperty.GeocoderMetaData.Address.Components");return n.forEach(e=>{switch(e.kind){case"locality":t.city=e.name;break;case"district":t.districts=e.name;break;case"house":t.house=e.name;break;case"entrance":t.entrance=e.name.match(/\d+/)?e.name.match(/\d+/)[0]:null;break;case"building":t.building=e.name}}),t}function M(){return"_"+Math.random().toString(36).substr(2,9)}function D(e,t){if(null==e||null==t)return!1;let n=e.split(",").slice(0,3).join(",").trim(),o=t.split(",").slice(0,3).join(",").trim();return n===o}async function L(){if(console.log("DATA selectedMarkerData: "+JSON.stringify(u)),!u)return tg.showAlert("Ошибка: данные адреса не найдены."),!1;{let{fullAddress:n,coords:o,details:a}=u,r=getStoredData(),{lastSelectedAddress:i,historySelectedAddresses:s}=r,l=s.findIndex(e=>D(e.full,n));-1!==l?(i=S(s[l],o,n,a),s[l]={...s[l],...i}):(i=_(o,a),s.push(i)),r.lastSelectedAddress=i,saveStoredData(r),P(i),e.style.display="none",t.style.display="none",toggleBodyScroll(!1),tg.BackButton.hide(),button_sendData()}return!0}function S(e,t,n,o){return{...e,lat:t[0],lon:t[1],full:n,short:o.short,coordinates:o?.coordinates??null,rawDetails:{...e.rawDetails,entrance:o.entrance||null}}}function _(e,t){return{id:M(),lat:e[0],lon:e[1],full:t.full,short:t.short,city:t.city||null,street:t.street||null,house:t.house||null,building:t.building||null,country:t.country||null,areas:t.areas||null,coordinates:t?.coordinates??null,rawDetails:{flat:null,floor:null,entrance:t.entrance||null,intercom:null,comment:null}}}function P(e){$('label[for="street"]').text(e.country+", "+e.city),streetInput.val(e.short||e.full),streetInput.val()&&streetInput.parent().addClass("has-value"),Object.entries({flat:"#flat",floor:"#floor",entrance:"#entrance",intercom:"#intercom",comment:"#order_place_comment"}).forEach(([t,n])=>{$(n).val(e.rawDetails[t])})}Telegram.WebApp.onEvent("mainButtonClicked",function(){let n=tg.MainButton.text;if(console.log("Click button ",n),"Продолжить"===n)confirmationSendData();else if("Сохранить"===n)tg.MainButton.showProgress(),L().then(e=>{console.log("Result:",e),tg.MainButton.hideProgress()}).catch(e=>{console.error("API error:",e),notify("К сожалению, адрес доставки не удалось сохранить.")});else if("Уточнить адрес"===n)e.style.display="flex",t.style.display="none";else if("Применить"===n){let o=document.getElementById("inputPromoCode").value;y(o).then(e=>{console.log("API response:",e);let t=document.getElementById("promoError");"error"===e.status?(t.textContent=e.error,t.style.display="block"):"ok"===e.status&&(document.getElementById("promoCodeInput").value=o,w(),E())}).catch(e=>{console.error("API error:",e)})}else console.warn("Неизвестный текст кнопки: ",n)}),[].forEach.call(document.querySelectorAll(".tel"),function(e){var t;function n(e){e.keyCode&&(t=e.keyCode),this.selectionStart<3&&e.preventDefault();var n="+7 (___) ___-__-__",o=0,a=n.replace(/\D/g,""),r=this.value.replace(/\D/g,""),i=n.replace(/[_\d]/g,function(e){return o<r.length?r.charAt(o++)||a.charAt(o):e});-1!=(o=i.indexOf("_"))&&(o<5&&(o=3),i=i.slice(0,o));var s=n.substr(0,this.value.length).replace(/_+/g,function(e){return"\\d{1,"+e.length+"}"}).replace(/[+()]/g,"\\$&");(!(s=RegExp("^"+s+"$")).test(this.value)||this.value.length<5||t>47&&t<58)&&(this.value=i),"blur"==e.type&&this.value.length<5&&(this.value="")}e.addEventListener("input",n,!0),e.addEventListener("focus",n,!0),e.addEventListener("blur",n,!0),e.addEventListener("keydown",n,!0)})}),MainStart();